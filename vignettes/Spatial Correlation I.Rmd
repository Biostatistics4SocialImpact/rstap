---
title: "Spatial Correlation I"
author: "Adam Peterson"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Spatial Correlation I}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE,echo=F}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
library(tidyverse)
library(rstap)
```

### No within BEF Spatial Correlation
```{r}
set.seed(1214)
num_subj <- 5.5E2
num_bef <- 1.5E2
sub_df <- data_frame(x = runif(n = num_subj, min = 1, max = 2.0),
                     y = runif(n = num_subj, min = 1, max = 2.0),
                     class = "Subject")
bef_df <- data_frame(x = runif(n = num_bef, min = 0, max = 3.0),
                     y = runif(n = num_bef, min = 0, max = 3.0),
                     class = "BEF")
rbind(sub_df,bef_df) %>% ggplot(aes(x = x, y = y, color = class )) +
    geom_point() + theme_bw() + ggtitle("Independence Configuration")
```

Then suppose the form of some measurement on the subjects is:

$$
E[Y_i] = \alpha + Z_i \delta + X_i(\theta)\beta_2\\
X_i(\theta) = \sum_{d \in \mathcal{D}_i} \text{erfc}(\frac{d}{\theta})
$$
Here we use the following 

```{r}
alpha <- 22.5
Z <- rbernoulli(n = num_subj, p = .45)
delta <- -.8
theta <- .5
beta <- 1.2
sigma <- 2.3
```

supposing we use all the data available (no exclusion distance), then 
this results in the following dataset

```{r}
dists <- fields::rdist(as.matrix(sub_df[,1:2]),
                       as.matrix(bef_df[,1:2]))
X <- apply(dists,1,function(x) sum(pracma::erfc(x/theta)))
X_tilde <- (X-mean(X))/sd(X) ## center and scale the exposure effect
y <- alpha + Z*delta + X_tilde*beta + rnorm(n = num_subj, mean = 0, sd = sigma)
hist(y)
```

```{r}
d <- seq(from = 0, to = max(dists), by = 0.01)
X_theta_one <- pracma::erfc(d/theta)
par(mfrow = c(1,2))
plot(d,X_theta_one,type='l',main = "Exposure Decay Function", xlab = "Distance",
     ylab = "Exposure")
hist(X_tilde)
```


Then we model this with rstap in the following manner

```{r}
distance_data <- dists %>% as_data_frame() %>%
    mutate(subj_id = 1:num_subj) %>% 
    gather(contains("V"),key = 'BEF',value = 'Distance') %>% 
    mutate(BEF = 'Fast_Food')

subject_data <- data_frame(subj_id = 1:num_subj,
                           y = y,
                           sex = factor(Z,labels=c("M","F")))

fit <- stap_glm(formula = y ~ sex + stap(Fast_Food),
                subject_data = subject_data,
                distance_data = distance_data,
                family = gaussian(link = 'identity'),
                id_key = 'subj_id',
                prior = normal(location = 0, scale = 5,autoscale = F),
                prior_intercept = normal(location = 25, scale = 5, autoscale = F),
                prior_stap = normal(location = 0, scale = 3, autoscale = F),
                prior_theta = log_normal(location = 0, scale = 1), 
                prior_aux = cauchy(location = 0,scale = 5),
                max_distance = max(dists), chains = 1)## include all data
```

```{r}
results <- rbind(c(alpha,delta,beta,theta),coef(fit))
rownames(results) <- c("True","Estimated")
results
```


```{r}
fit$ses
```
We'll take this as sufficient evidence (for this vignette) that the model works. 
Typical model criticism can be found in a different vignette (to be added later).
Let's now examine the case when we mis-specify the inclusion distance.

Note that the histogram of distances include many over 1 unit - which
from the above graph we know only add "negligible" information. 
```{r}
hist(dists)
```

Keeping this in mind - let's see what happens to our estimates
when we set the exclusion distance to be 1.25 miles.


```{r}
fit_125 <- stap_glm(y ~ sex + stap(Fast_Food), subject_data = subject_data,
                distance_data = distance_data,
                family = gaussian(link = 'identity'),
                id_key = 'subj_id',
                prior = normal(location = 0,scale = 5,autoscale = F),
                prior_intercept = normal(location = 25, scale = 5, autoscale = F),
                prior_stap = normal(location = 0, scale = 3, autoscale = F),
                prior_theta = log_normal(location = 0, scale = 1), 
                prior_aux = cauchy(location = 0,scale = 5),
                max_distance = 1.25, chains = 1)
```


```{r}
sum(dists<=1.25)/sum(dists>=0) ## we excluded about half of the total data (not evenly across individuals)
```

```{r}
results_2 <- rbind(c(alpha,delta,beta,theta),coef(fit_125))
rownames(results_2) <- c("True","Estimated")
results_2
```


```{R}
fit_125$ses
```
## Now let's see what happens when we mis-specify the maximum distance
and this results in a loss of "meaningful" Built Environment Features.
```{r}
fit_25 <- stap_glm(y ~ sex + stap(Fast_Food), subject_data = subject_data,
                distance_data = distance_data,
                family = gaussian(link = 'identity'),
                id_key = 'subj_id',
                prior = normal(location = 0,scale = 5,autoscale = F),
                prior_intercept = normal(location = 25, scale = 5, autoscale = F),
                prior_stap = normal(location = 0, scale = 3, autoscale = F),
                prior_theta = log_normal(location = 0, scale = 1), 
                prior_aux = cauchy(location = 0,scale = 5),
                max_distance = .25, chains = 1) 
```


```{r}
results_3 <- rbind(c(alpha,delta,beta,theta),coef(fit_25))
rownames(results_3) <- c("True","Estimated")
results_3
```

```{r}
rbind(fit$ses,fit_125$ses,fit_25$ses)
```

We start to see some bias, as we should, in addition to increased noise, since 
we're increasingly missing informative data for our spatial parameter.

