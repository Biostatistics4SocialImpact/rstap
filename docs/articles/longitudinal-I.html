<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>STAP in a Longitudinal Data Setting • rstap</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js" integrity="sha384-cV+rhyOuRHc9Ub/91rihWcGmMmCXDeksTtCihMupQHSsi8GIIRDG0ThDc3HGQFJ3" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="STAP in a Longitudinal Data Setting">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">rstap</a>
        <span class="label label-default" data-toggle="tooltip" data-placement="bottom" title="Released package">0.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/Introduction.html">STAP Introduction</a>
    </li>
    <li>
      <a href="../articles/Spatial_Correlation_I.html">STAP-Spatial_Correlation</a>
    </li>
    <li>
      <a href="../articles/clustered_poisson.html">Spatial Correlation II</a>
    </li>
    <li>
      <a href="../articles/longitudinal-I.html">STAP in a Longitudinal Data Setting</a>
    </li>
    <li>
      <a href="../articles/longitudinal-ii.html">Longitudinal Setting </a>
    </li>
    <li>
      <a href="../articles/misspecified-weightfunction.html">Mis-Specified Weight Function</a>
    </li>
    <li>
      <a href="../articles/scale-priors.html">Scale Priors</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>STAP in a Longitudinal Data Setting</h1>
            
      
      
      <div class="hidden name"><code>longitudinal-I.Rmd</code></div>

    </div>

    
    
<p>Spatial-temporal aggregated predictor (STAP) models extension in the longitudinal setting incorporates heirarchical variance components to account for within subject or group-level correlation.</p>
<p>This setting also involves a substantially different data structure, since exposure to built environment features now occurs across time and subjects can move across time or space. Additionally since subjects may drop out of a study and built-environment features - stores - may close or open, the staps are neccessarily different at each measurement. The inclusion of these repeated measures, requires a secondary id to join on in addition to the typical <code>id_key</code> for the <code>distance_data</code> and <code>time_data</code> arguments to the <code>stap_glmer</code> function. We’ll demonstrate this and the stap model with random effects using the simple case of homogenously distributed built environment features, with subjects measured across two time points.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(dplyr)
<span class="kw">library</span>(tidyr)
<span class="kw">library</span>(ggplot2)
<span class="kw">library</span>(rstap)
<span class="kw">library</span>(plot3D)</code></pre></div>
<div id="measurement-data" class="section level2">
<h2 class="hasAnchor">
<a href="#measurement-data" class="anchor"></a>Measurement Data</h2>
<p>Below we can see what the data, when initially measured, might look like before preparing it for model fitting.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">knitr<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/knitr/topics/kable">kable</a></span>(<span class="kw">head</span>(subj_data))</code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="right">x</th>
<th align="right">y</th>
<th align="left">date</th>
<th align="right">ID</th>
<th align="left">class</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">0.7253479</td>
<td align="right">-0.7452062</td>
<td align="left">1974-05-11</td>
<td align="right">1</td>
<td align="left">Subject</td>
</tr>
<tr class="even">
<td align="right">-0.6051202</td>
<td align="right">-0.2405906</td>
<td align="left">1976-03-04</td>
<td align="right">2</td>
<td align="left">Subject</td>
</tr>
<tr class="odd">
<td align="right">0.1696653</td>
<td align="right">0.5845662</td>
<td align="left">1976-04-15</td>
<td align="right">3</td>
<td align="left">Subject</td>
</tr>
<tr class="even">
<td align="right">-0.3834797</td>
<td align="right">-0.9895510</td>
<td align="left">1986-12-24</td>
<td align="right">4</td>
<td align="left">Subject</td>
</tr>
<tr class="odd">
<td align="right">0.2920221</td>
<td align="right">0.7254065</td>
<td align="left">1987-07-17</td>
<td align="right">5</td>
<td align="left">Subject</td>
</tr>
<tr class="even">
<td align="right">0.8772785</td>
<td align="right">-0.7254489</td>
<td align="left">1974-01-31</td>
<td align="right">6</td>
<td align="left">Subject</td>
</tr>
</tbody>
</table>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">knitr<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/knitr/topics/kable">kable</a></span>(<span class="kw">head</span>(bef_data))</code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="right">x</th>
<th align="right">y</th>
<th align="left">date_open</th>
<th align="left">date_close</th>
<th align="right">ID</th>
<th align="left">class</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">0.7851891</td>
<td align="right">0.3844256</td>
<td align="left">1967-07-31</td>
<td align="left">NA</td>
<td align="right">1</td>
<td align="left">Coffee_Shop</td>
</tr>
<tr class="even">
<td align="right">-0.0703001</td>
<td align="right">-0.7953893</td>
<td align="left">1961-11-26</td>
<td align="left">NA</td>
<td align="right">2</td>
<td align="left">Coffee_Shop</td>
</tr>
<tr class="odd">
<td align="right">0.0178176</td>
<td align="right">-0.6283173</td>
<td align="left">1968-02-10</td>
<td align="left">NA</td>
<td align="right">3</td>
<td align="left">Coffee_Shop</td>
</tr>
<tr class="even">
<td align="right">-0.5009678</td>
<td align="right">-0.6053075</td>
<td align="left">1968-11-16</td>
<td align="left">NA</td>
<td align="right">4</td>
<td align="left">Coffee_Shop</td>
</tr>
<tr class="odd">
<td align="right">0.5744385</td>
<td align="right">0.5685900</td>
<td align="left">1969-07-13</td>
<td align="left">NA</td>
<td align="right">5</td>
<td align="left">Coffee_Shop</td>
</tr>
<tr class="even">
<td align="right">0.7722542</td>
<td align="right">-0.7553629</td>
<td align="left">1962-07-05</td>
<td align="left">NA</td>
<td align="right">6</td>
<td align="left">Coffee_Shop</td>
</tr>
</tbody>
</table>
<p>The third and final dataset involves the subject specific data and the dates at which the measurements were taken.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">subj_fdata <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span>(ID) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">head</span>() <span class="op">%&gt;%</span><span class="st"> </span>knitr<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/knitr/topics/kable">kable</a></span>()</code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="right">ID</th>
<th align="right">sex</th>
<th align="left">DOB</th>
<th align="right">Income</th>
<th align="left">measure_date</th>
<th align="right">Age</th>
<th align="right">measure_ID</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">1</td>
<td align="right">0</td>
<td align="left">1969-04-19</td>
<td align="right">55.82780</td>
<td align="left">2000-07-30</td>
<td align="right">31.30137</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="right">1</td>
<td align="right">0</td>
<td align="left">1969-04-19</td>
<td align="right">164.21804</td>
<td align="left">2003-11-08</td>
<td align="right">34.57808</td>
<td align="right">2</td>
</tr>
<tr class="odd">
<td align="right">2</td>
<td align="right">1</td>
<td align="left">1953-05-04</td>
<td align="right">73.82412</td>
<td align="left">2000-04-11</td>
<td align="right">46.96986</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="right">2</td>
<td align="right">1</td>
<td align="left">1953-05-04</td>
<td align="right">168.65774</td>
<td align="left">2002-04-16</td>
<td align="right">48.98356</td>
<td align="right">2</td>
</tr>
<tr class="odd">
<td align="right">3</td>
<td align="right">1</td>
<td align="left">1965-08-01</td>
<td align="right">36.23697</td>
<td align="left">2000-12-05</td>
<td align="right">35.36986</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="right">3</td>
<td align="right">1</td>
<td align="left">1965-08-01</td>
<td align="right">131.82313</td>
<td align="left">2002-12-04</td>
<td align="right">37.36712</td>
<td align="right">2</td>
</tr>
</tbody>
</table>
</div>
<div id="transforming-the-measured-data" class="section level2">
<h2 class="hasAnchor">
<a href="#transforming-the-measured-data" class="anchor"></a>Transforming the Measured Data</h2>
<p>In order to join these datasets, a new ID has to be created to associate the spatial-temporal data with a specific measurement date. We create this ID to include all spatial data up to and including the measurement date for each subject.</p>
<p>Note that for subjects one and two there are two rows, corresponding to the two measurements. In contrast, subject nine has four rows, corresponding to the fact that subject 9’s move before the two measurements results in both locations of 9’s residence being associated with all measurements subsequently measured.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">subj_data <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/join.html">left_join</a></span>(subj_fdata,<span class="dt">by=</span><span class="st">"ID"</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(ID <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">9</span>)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/select.html">select</a></span>(ID,measure_ID,x,y,date,measure_date) <span class="op">%&gt;%</span><span class="st"> </span>knitr<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/knitr/topics/kable">kable</a></span>()</code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="right">ID</th>
<th align="right">measure_ID</th>
<th align="right">x</th>
<th align="right">y</th>
<th align="left">date</th>
<th align="left">measure_date</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">1</td>
<td align="right">1</td>
<td align="right">0.7253479</td>
<td align="right">-0.7452062</td>
<td align="left">1974-05-11</td>
<td align="left">2000-07-30</td>
</tr>
<tr class="even">
<td align="right">1</td>
<td align="right">2</td>
<td align="right">0.7253479</td>
<td align="right">-0.7452062</td>
<td align="left">1974-05-11</td>
<td align="left">2003-11-08</td>
</tr>
<tr class="odd">
<td align="right">2</td>
<td align="right">1</td>
<td align="right">-0.6051202</td>
<td align="right">-0.2405906</td>
<td align="left">1976-03-04</td>
<td align="left">2000-04-11</td>
</tr>
<tr class="even">
<td align="right">2</td>
<td align="right">2</td>
<td align="right">-0.6051202</td>
<td align="right">-0.2405906</td>
<td align="left">1976-03-04</td>
<td align="left">2002-04-16</td>
</tr>
<tr class="odd">
<td align="right">9</td>
<td align="right">1</td>
<td align="right">-0.7904145</td>
<td align="right">-0.8712954</td>
<td align="left">1985-09-21</td>
<td align="left">2000-10-24</td>
</tr>
<tr class="even">
<td align="right">9</td>
<td align="right">2</td>
<td align="right">-0.7904145</td>
<td align="right">-0.8712954</td>
<td align="left">1985-09-21</td>
<td align="left">2001-01-04</td>
</tr>
</tbody>
</table>
</div>
<div id="stores-opening-and-closing-subjects-moving-in-the-data" class="section level2">
<h2 class="hasAnchor">
<a href="#stores-opening-and-closing-subjects-moving-in-the-data" class="anchor"></a>Stores Opening and Closing, Subjects Moving in the Data</h2>
<p>Here we can see the effect of a store closing (BEF_ID 10) and a subject moving (subj_ID 9) on the data structure. Note that first row’s time is ~25.8 years which reflects the time spent since the <em>subject</em> first moved to their location. Since neither the subject nor the business moves by the subject’s second measurement in July of 2001, we see that the distances betwen subject 1 and Coffee Shop 1 stay constant, and the time increases according to the difference in measurement date, only.</p>
<p>In contrast, we see the effect of a subject moving for subj_ID 9. Here (s)he has twice as many measurements to show her/his exposure to the same coffee shop at the different locations where subj 9 lived. This is shown most evidently in the constant exposure for for coffee shops at the 1985 location for subject 9. Since subject 9 moved after ~6 years, and coffee shop 1 hadn’t closed at that time, subject 9 only has 6 years of exposure to that coffee shop at that distance. Following this we can see a steadily increasing exposure until the coffee shop closes in 2002, roughly a year before the subject’s second measurement in ’03.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">td_data  <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(subj_ID <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">9</span>),bef_ID<span class="op">%in%</span><span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">10</span>)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span>(subj_ID,measure_ID,bef_ID) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span>knitr<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/knitr/topics/kable">kable</a></span>()</code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="right">subj_ID</th>
<th align="right">measure_ID</th>
<th align="right">bef_ID</th>
<th align="left">measure_date</th>
<th align="left">date_open</th>
<th align="left">date_close</th>
<th align="left">date</th>
<th align="left">class</th>
<th align="right">dist</th>
<th align="left">time</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">1</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="left">2000-07-30</td>
<td align="left">1967-07-31</td>
<td align="left">NA</td>
<td align="left">1974-05-11</td>
<td align="left">Coffee_Shop</td>
<td align="right">1.131216</td>
<td align="left">26.23836 days</td>
</tr>
<tr class="even">
<td align="right">1</td>
<td align="right">1</td>
<td align="right">10</td>
<td align="left">2000-07-30</td>
<td align="left">1963-09-19</td>
<td align="left">NA</td>
<td align="left">1974-05-11</td>
<td align="left">Coffee_Shop</td>
<td align="right">1.961466</td>
<td align="left">26.23836 days</td>
</tr>
<tr class="odd">
<td align="right">1</td>
<td align="right">2</td>
<td align="right">1</td>
<td align="left">2003-11-08</td>
<td align="left">1967-07-31</td>
<td align="left">NA</td>
<td align="left">1974-05-11</td>
<td align="left">Coffee_Shop</td>
<td align="right">1.131216</td>
<td align="left">29.51507 days</td>
</tr>
<tr class="even">
<td align="right">1</td>
<td align="right">2</td>
<td align="right">10</td>
<td align="left">2003-11-08</td>
<td align="left">1963-09-19</td>
<td align="left">NA</td>
<td align="left">1974-05-11</td>
<td align="left">Coffee_Shop</td>
<td align="right">1.961466</td>
<td align="left">29.51507 days</td>
</tr>
<tr class="odd">
<td align="right">9</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="left">2000-10-24</td>
<td align="left">1967-07-31</td>
<td align="left">NA</td>
<td align="left">1985-09-21</td>
<td align="left">Coffee_Shop</td>
<td align="right">2.014786</td>
<td align="left">15.10137 days</td>
</tr>
<tr class="even">
<td align="right">9</td>
<td align="right">1</td>
<td align="right">10</td>
<td align="left">2000-10-24</td>
<td align="left">1963-09-19</td>
<td align="left">NA</td>
<td align="left">1985-09-21</td>
<td align="left">Coffee_Shop</td>
<td align="right">1.823751</td>
<td align="left">15.10137 days</td>
</tr>
<tr class="odd">
<td align="right">9</td>
<td align="right">2</td>
<td align="right">1</td>
<td align="left">2001-01-04</td>
<td align="left">1967-07-31</td>
<td align="left">NA</td>
<td align="left">1985-09-21</td>
<td align="left">Coffee_Shop</td>
<td align="right">2.014786</td>
<td align="left">15.29863 days</td>
</tr>
<tr class="even">
<td align="right">9</td>
<td align="right">2</td>
<td align="right">10</td>
<td align="left">2001-01-04</td>
<td align="left">1963-09-19</td>
<td align="left">NA</td>
<td align="left">1985-09-21</td>
<td align="left">Coffee_Shop</td>
<td align="right">1.823751</td>
<td align="left">15.29863 days</td>
</tr>
</tbody>
</table>
</div>
<div id="simulating-and-estimating-a-stap-model" class="section level1">
<h1 class="hasAnchor">
<a href="#simulating-and-estimating-a-stap-model" class="anchor"></a>Simulating and Estimating a STAP model</h1>
<p>If we were to assume the following model from the previous data set-up</p>
<p><span class="math display">\[
E[Y_{ij}|b_i] = \alpha + Z_1\delta_{Income} + Z_{2}\delta_{sex} + Z_{3}\delta_{Age} + X(\theta_s,\theta_t)\beta_{Coffee} + b_i
\]</span> Where <span class="math display">\[
X(\theta_s,\theta_t) = \sum_{d\in\mathcal{D}} w_d(\frac{d}{\theta_s}) w_t(\frac{t}{\theta_t}) 
\]</span></p>
<p>and simulate it under the following fixed values</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">alpha &lt;-<span class="st"> </span><span class="dv">22</span>
delta &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dt">Income =</span> <span class="op">-</span>.<span class="dv">35</span>,<span class="dt">sex =</span> <span class="fl">1.1</span>, <span class="dt">Age =</span> <span class="fl">1.2</span>)
beta &lt;-<span class="st"> </span><span class="dv">1</span>
theta_s &lt;-<span class="st"> </span>.<span class="dv">8</span>
theta_t &lt;-<span class="st"> </span><span class="dv">18</span>
sigma &lt;-<span class="st"> </span><span class="dv">2</span>
tau &lt;-<span class="st"> </span><span class="fl">1.5</span>
d &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="dt">from =</span> <span class="dv">0</span>, <span class="dt">to =</span> <span class="kw">max</span>(td_data<span class="op">$</span>dist), <span class="dt">by =</span> <span class="fl">0.01</span>)
t &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="dt">from =</span> <span class="dv">0</span>, <span class="dt">to =</span> <span class="kw">as.numeric</span>(<span class="kw">max</span>(td_data<span class="op">$</span>time)), <span class="dt">by =</span> <span class="fl">0.05</span>)
w_s &lt;-<span class="st"> </span>pracma<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/pracma/topics/erfz">erfc</a></span>(d<span class="op">/</span>theta_s)
w_t &lt;-<span class="st"> </span>pracma<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/pracma/topics/erfz">erf</a></span>(t<span class="op">/</span>theta_t)</code></pre></div>
<p>We could see the individual spatial and temporal exposure functions</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">par</span>(<span class="dt">mfrow=</span><span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">2</span>))
<span class="kw">plot</span>(d,w_s,<span class="dt">type=</span><span class="st">'l'</span>, <span class="dt">main=</span><span class="st">"Spatial Decay"</span>,<span class="dt">xlab =</span> <span class="st">"Distance"</span>, <span class="dt">ylab =</span><span class="st">"Exposure"</span>)
<span class="kw">plot</span>(t,w_t,<span class="dt">type =</span> <span class="st">"l"</span>, <span class="dt">main =</span> <span class="st">"Temporal Accumulation"</span>,<span class="dt">xlab=</span><span class="st">'years'</span>, <span class="dt">ylab =</span> <span class="st">"Exposure"</span>)</code></pre></div>
<p><img src="longitudinal-I_files/figure-html/s-t-exp-1.png" width="700"></p>
<p>As well as the joint spatial-temporal exposure surface: <img src="longitudinal-I_files/figure-html/st_exp_plot-1.png" width="700"></p>
<p>This results in the following exposure density across the population. Note that the exposure density value increases between the two measurements. This reflects the increased impact as a result of spending more time in the same space. With real data this may not be the case, given that individuals</p>
<p><img src="longitudinal-I_files/figure-html/total_exposure-1.png" width="700"></p>
<p><img src="longitudinal-I_files/figure-html/create_exposure-1.png" width="700"></p>
<p><img src="longitudinal-I_files/figure-html/unnamed-chunk-1-1.png" width="700"></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">subj_fdata &lt;-<span class="st"> </span>subj_fdata <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/join.html">left_join</a></span>(<span class="kw">cbind</span>(lme_inf<span class="op">$</span>fr,y,y_bern),<span class="dt">by=</span><span class="kw">c</span>(<span class="st">"ID"</span>,<span class="st">"measure_ID"</span>))  <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">sex =</span> sex.x, <span class="dt">Coffee_Shop=</span> Coffee_Shop.x,<span class="dt">subj_ID=</span>ID,
           <span class="dt">centered_income =</span> <span class="st">`</span><span class="dt">I((Income - mean(Income))/sd(Income))</span><span class="st">`</span>,
           <span class="dt">centered_age =</span> <span class="st">`</span><span class="dt">I((Age - mean(Age))/sd(Age))</span><span class="st">`</span>) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/select.html">select</a></span>(subj_ID,DOB,Coffee_Shop,sex,
           centered_income,centered_age,y,y_bern,
           ran_int,measure_ID,Age,Income)</code></pre></div>
<p>The final datasets passed to the <code>stap_glmer</code> function will then be the subject specific data, and then the distance and/or time dataset corresponding to whether or not a spatial or temporal scale is estimated.</p>
<table class="table">
<thead><tr class="header">
<th align="right">subj_ID</th>
<th align="right">Income</th>
<th align="right">measure_ID</th>
<th align="right">Age</th>
<th align="right">ran_int</th>
<th align="right">y</th>
<th align="right">sex</th>
<th align="right">Coffee_Shop</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">1</td>
<td align="right">55.82780</td>
<td align="right">1</td>
<td align="right">31.30137</td>
<td align="right">0.2581927</td>
<td align="right">27.79630</td>
<td align="right">0</td>
<td align="right">8.470124</td>
</tr>
<tr class="even">
<td align="right">2</td>
<td align="right">73.82412</td>
<td align="right">1</td>
<td align="right">46.96986</td>
<td align="right">-0.6825780</td>
<td align="right">33.81810</td>
<td align="right">1</td>
<td align="right">8.489090</td>
</tr>
<tr class="odd">
<td align="right">3</td>
<td align="right">36.23697</td>
<td align="right">1</td>
<td align="right">35.36986</td>
<td align="right">0.4801513</td>
<td align="right">33.05382</td>
<td align="right">1</td>
<td align="right">8.991242</td>
</tr>
<tr class="even">
<td align="right">4</td>
<td align="right">28.86876</td>
<td align="right">1</td>
<td align="right">36.47671</td>
<td align="right">2.8948296</td>
<td align="right">32.27050</td>
<td align="right">1</td>
<td align="right">3.582213</td>
</tr>
<tr class="odd">
<td align="right">5</td>
<td align="right">47.23422</td>
<td align="right">1</td>
<td align="right">39.40822</td>
<td align="right">0.9040974</td>
<td align="right">29.30665</td>
<td align="right">0</td>
<td align="right">6.115291</td>
</tr>
<tr class="even">
<td align="right">6</td>
<td align="right">78.05369</td>
<td align="right">1</td>
<td align="right">32.98082</td>
<td align="right">0.0097133</td>
<td align="right">26.87130</td>
<td align="right">1</td>
<td align="right">6.953036</td>
</tr>
</tbody>
</table>
<table class="table">
<thead><tr class="header">
<th align="right">subj_ID</th>
<th align="right">measure_ID</th>
<th align="left">date</th>
<th align="right">bef_ID</th>
<th align="left">class</th>
<th align="right">dist</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">1</td>
<td align="right">1</td>
<td align="left">1974-05-11</td>
<td align="right">1</td>
<td align="left">Coffee_Shop</td>
<td align="right">1.1312156</td>
</tr>
<tr class="even">
<td align="right">2</td>
<td align="right">1</td>
<td align="left">1976-03-04</td>
<td align="right">1</td>
<td align="left">Coffee_Shop</td>
<td align="right">1.5243376</td>
</tr>
<tr class="odd">
<td align="right">3</td>
<td align="right">1</td>
<td align="left">1976-04-15</td>
<td align="right">1</td>
<td align="left">Coffee_Shop</td>
<td align="right">0.6472447</td>
</tr>
<tr class="even">
<td align="right">4</td>
<td align="right">1</td>
<td align="left">1986-12-24</td>
<td align="right">1</td>
<td align="left">Coffee_Shop</td>
<td align="right">1.8037734</td>
</tr>
<tr class="odd">
<td align="right">5</td>
<td align="right">1</td>
<td align="left">1987-07-17</td>
<td align="right">1</td>
<td align="left">Coffee_Shop</td>
<td align="right">0.5995679</td>
</tr>
<tr class="even">
<td align="right">6</td>
<td align="right">1</td>
<td align="left">1974-01-31</td>
<td align="right">1</td>
<td align="left">Coffee_Shop</td>
<td align="right">1.1136884</td>
</tr>
</tbody>
</table>
<table class="table">
<thead><tr class="header">
<th align="right">subj_ID</th>
<th align="right">measure_ID</th>
<th align="left">date</th>
<th align="right">bef_ID</th>
<th align="left">class</th>
<th align="left">time</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">1</td>
<td align="right">1</td>
<td align="left">1974-05-11</td>
<td align="right">1</td>
<td align="left">Coffee_Shop</td>
<td align="left">26.23836 days</td>
</tr>
<tr class="even">
<td align="right">2</td>
<td align="right">1</td>
<td align="left">1976-03-04</td>
<td align="right">1</td>
<td align="left">Coffee_Shop</td>
<td align="left">24.12055 days</td>
</tr>
<tr class="odd">
<td align="right">3</td>
<td align="right">1</td>
<td align="left">1976-04-15</td>
<td align="right">1</td>
<td align="left">Coffee_Shop</td>
<td align="left">24.65753 days</td>
</tr>
<tr class="even">
<td align="right">4</td>
<td align="right">1</td>
<td align="left">1986-12-24</td>
<td align="right">1</td>
<td align="left">Coffee_Shop</td>
<td align="left">13.54795 days</td>
</tr>
<tr class="odd">
<td align="right">5</td>
<td align="right">1</td>
<td align="left">1987-07-17</td>
<td align="right">1</td>
<td align="left">Coffee_Shop</td>
<td align="left">13.05479 days</td>
</tr>
<tr class="even">
<td align="right">6</td>
<td align="right">1</td>
<td align="left">1974-01-31</td>
<td align="right">1</td>
<td align="left">Coffee_Shop</td>
<td align="left">26.65753 days</td>
</tr>
</tbody>
</table>
<p>We’ll fit the data with priors that reflect our relative uncertainty about the spatial and temporal scales and place a fairly uninformative prior on the subject-specific variance. For information on how priors are set on the subject specific covariance, see the <code>rstanarm</code> vignette’s write up <a href="http://mc-stan.org/rstanarm/articles/glmer.html">here</a>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">fit &lt;-<span class="st"> </span><span class="kw"><a href="../reference/stap_glmer.html">stap_lmer</a></span>(y <span class="op">~</span><span class="st"> </span>centered_income <span class="op">+</span><span class="st">  </span>sex <span class="op">+</span><span class="st"> </span>centered_age <span class="op">+</span><span class="st"> </span><span class="kw">stap</span>(Coffee_Shop) <span class="op">+</span><span class="st"> </span>(<span class="dv">1</span><span class="op">|</span>subj_ID),
                  <span class="dt">subject_data =</span> homog_longitudinal_subject_data, ## names of datasets 
                  <span class="dt">distance_data =</span> homog_longitudinal_distance_data,##  simulated above
                  <span class="dt">time_data =</span> homog_longitudinal_time_data, ## in the rstap package
                  <span class="dt">subject_ID =</span> <span class="st">'subj_ID'</span>, 
                  <span class="dt">group_ID =</span> <span class="st">'measure_ID'</span>,
                  <span class="dt">prior_intercept =</span> <span class="kw"><a href="../reference/priors.html">normal</a></span>(<span class="dt">location =</span> <span class="dv">25</span>, <span class="dt">scale =</span> <span class="dv">4</span>, <span class="dt">autoscale =</span> F),
                  <span class="dt">prior =</span> <span class="kw"><a href="../reference/priors.html">normal</a></span>(<span class="dt">location =</span> <span class="dv">0</span>, <span class="dt">scale =</span> <span class="dv">4</span>,<span class="dt">autoscale=</span>F),
                  <span class="dt">prior_stap =</span> <span class="kw"><a href="../reference/priors.html">normal</a></span>(<span class="dt">location =</span> <span class="dv">0</span>, <span class="dt">scale =</span> <span class="dv">4</span>),
                  <span class="dt">prior_theta =</span> <span class="kw">list</span>(<span class="dt">Coffee_Shop =</span> <span class="kw">list</span>(<span class="dt">spatial =</span> <span class="kw"><a href="../reference/priors.html">log_normal</a></span>(<span class="dt">location =</span> <span class="dv">1</span>,
                                                                             <span class="dt">scale =</span> <span class="dv">1</span>),
                                                        <span class="dt">temporal =</span> <span class="kw"><a href="../reference/priors.html">log_normal</a></span>(<span class="dt">location =</span> <span class="dv">1</span>, 
                                                                              <span class="dt">scale =</span> <span class="dv">1</span>))),
                  <span class="dt">prior_covariance =</span> <span class="kw"><a href="../reference/priors.html">decov</a></span>(<span class="dt">regularization =</span> <span class="dv">1</span>,<span class="dt">concentration =</span> <span class="dv">1</span>,
                                          <span class="dt">shape =</span> <span class="dv">1</span>,<span class="dt">scale =</span> <span class="dv">1</span>),
                  <span class="dt">prior_aux =</span> <span class="kw"><a href="../reference/priors.html">cauchy</a></span>(<span class="dv">0</span>,<span class="dv">5</span>),
                  <span class="dt">max_distance =</span> <span class="dv">3</span>, 
                  <span class="dt">max_time =</span> <span class="dv">50</span>,
                  <span class="dt">chains =</span> <span class="dv">4</span>,
                  <span class="dt">iter =</span> <span class="fl">2E3</span>,
                  <span class="dt">cores =</span> <span class="dv">4</span>)</code></pre></div>
<p>we can now look at our estimates.</p>
<p><img src="longitudinal-I_files/figure-html/unnamed-chunk-4-1.png" width="700"></p>
<p>We see that even though the temporal scale was quite a fair bit away from the bulk of the prior, the log normal tail and sufficiently data heavy likelihood allowed for a tight posterior interval around the temporal scale. Other parameter estimates were all accurate as well.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#measurement-data">Measurement Data</a></li>
      <li><a href="#transforming-the-measured-data">Transforming the Measured Data</a></li>
      <li><a href="#stores-opening-and-closing-subjects-moving-in-the-data">Stores Opening and Closing, Subjects Moving in the Data</a></li>
      <li><a href="#simulating-and-estimating-a-stap-model">Simulating and Estimating a STAP model</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Adam Peterson.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://pkgdown.r-lib.org/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  

  </body>
</html>
