<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>STAP in a Longitudinal Data Setting • rstap</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js" integrity="sha384-cV+rhyOuRHc9Ub/91rihWcGmMmCXDeksTtCihMupQHSsi8GIIRDG0ThDc3HGQFJ3" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="STAP in a Longitudinal Data Setting">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">rstap</a>
        <span class="label label-default" data-toggle="tooltip" data-placement="bottom" title="Released package">0.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/Introduction.html">STAP Introduction</a>
    </li>
    <li>
      <a href="../articles/Spatial_Correlation_I.html">STAP-Spatial_Correlation</a>
    </li>
    <li>
      <a href="../articles/clustered_poisson.html">Spatial Correlation II</a>
    </li>
    <li>
      <a href="../articles/longitudinal-I.html">STAP in a Longitudinal Data Setting</a>
    </li>
    <li>
      <a href="../articles/longitudinal-ii.html">Longitudinal Setting - Multiple Timepoints </a>
    </li>
    <li>
      <a href="../articles/misspecified-weightfunction.html">Mis-Specified Weight Function</a>
    </li>
    <li>
      <a href="../articles/scale-priors.html">Scale Priors</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>STAP in a Longitudinal Data Setting</h1>
            
      
      
      <div class="hidden name"><code>longitudinal-I.Rmd</code></div>

    </div>

    
    
<p>Spatial-temporal aggregated predictor (STAP) models extension in the longitudinal setting incorporates heirarchical variance components to account for within subject or group-level correlation.</p>
<p>This setting also involves a substantially different data structure, since exposure to built environment features now occurs across time and subjects can move across time or space. Additionally since subjects may drop out of a study and built-environment features - stores - may close or open, the staps are neccessarily different at each measurement. The inclusion of these repeated measures, requires a secondary id to join on in addition to the typical <code>id_key</code> for the <code>distance_data</code> and <code>time_data</code> arguments to the <code>stap_glmer</code> function. We’ll demonstrate this and the stap model with random effects using the simple case of homogenously distributed built environment features, with subjects measured across two time points.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(dplyr)
<span class="kw">library</span>(tidyr)
<span class="kw">library</span>(ggplot2)
<span class="kw">library</span>(rstap)
<span class="kw">library</span>(plot3D)</code></pre></div>
<div id="measurement-data" class="section level2">
<h2 class="hasAnchor">
<a href="#measurement-data" class="anchor"></a>Measurement Data</h2>
<p>Below we can see what the data, when initially measured, might look like before preparing it for model fitting.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">list</span>(<span class="st">'Subject Spatial-Temporal Data'</span> =<span class="st"> </span>subj_data,
     <span class="st">"BEF Spatial-Temporal Data"</span> =<span class="st"> </span>bef_data)
<span class="co">#&gt; $`Subject Spatial-Temporal Data`</span>
<span class="co">#&gt; # A tibble: 167 x 5</span>
<span class="co">#&gt;           x      y date          ID class  </span>
<span class="co">#&gt;       &lt;dbl&gt;  &lt;dbl&gt; &lt;date&gt;     &lt;int&gt; &lt;chr&gt;  </span>
<span class="co">#&gt;  1 -0.701   -0.412 1974-05-11     1 Subject</span>
<span class="co">#&gt;  2 -0.415    0.622 1976-03-04     2 Subject</span>
<span class="co">#&gt;  3 -0.924   -0.314 1976-04-15     3 Subject</span>
<span class="co">#&gt;  4 -0.700   -0.700 1986-12-24     4 Subject</span>
<span class="co">#&gt;  5 -0.00932 -0.262 1987-07-17     5 Subject</span>
<span class="co">#&gt;  6 -0.624    0.272 1974-01-31     6 Subject</span>
<span class="co">#&gt;  7  0.296   -0.401 1988-06-05     7 Subject</span>
<span class="co">#&gt;  8  0.607   -0.418 1975-01-01     8 Subject</span>
<span class="co">#&gt;  9 -0.0141  -0.708 1985-09-21     9 Subject</span>
<span class="co">#&gt; 10 -0.557    0.561 1971-08-03    10 Subject</span>
<span class="co">#&gt; # ... with 157 more rows</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $`BEF Spatial-Temporal Data`</span>
<span class="co">#&gt; # A tibble: 55 x 6</span>
<span class="co">#&gt;         x       y date_open  date_close    ID class      </span>
<span class="co">#&gt;     &lt;dbl&gt;   &lt;dbl&gt; &lt;date&gt;     &lt;date&gt;     &lt;int&gt; &lt;chr&gt;      </span>
<span class="co">#&gt;  1  0.624  0.916  1969-05-14 NA             1 Coffee_Shop</span>
<span class="co">#&gt;  2 -0.351 -0.796  1963-10-23 NA             2 Coffee_Shop</span>
<span class="co">#&gt;  3  0.893 -0.839  1960-09-12 NA             3 Coffee_Shop</span>
<span class="co">#&gt;  4  0.199 -0.140  1965-04-20 NA             4 Coffee_Shop</span>
<span class="co">#&gt;  5 -0.822  0.841  1962-06-28 NA             5 Coffee_Shop</span>
<span class="co">#&gt;  6 -0.673 -0.549  1968-02-01 NA             6 Coffee_Shop</span>
<span class="co">#&gt;  7  0.177  0.0337 1963-10-15 NA             7 Coffee_Shop</span>
<span class="co">#&gt;  8  0.364 -0.404  1963-12-30 NA             8 Coffee_Shop</span>
<span class="co">#&gt;  9  0.430  0.812  1968-10-09 NA             9 Coffee_Shop</span>
<span class="co">#&gt; 10 -0.383 -0.621  1961-05-18 2002-09-23    10 Coffee_Shop</span>
<span class="co">#&gt; # ... with 45 more rows</span></code></pre></div>
<p>The third and final dataset involves the subject specific data and the dates at which the measurements were taken.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">subj_fdata <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span>(ID)
<span class="co">#&gt; # A tibble: 291 x 7</span>
<span class="co">#&gt;       ID   sex DOB        Income measure_date   Age measure_ID</span>
<span class="co">#&gt;    &lt;int&gt; &lt;int&gt; &lt;date&gt;      &lt;dbl&gt; &lt;date&gt;       &lt;dbl&gt;      &lt;dbl&gt;</span>
<span class="co">#&gt;  1     1     1 1956-08-11   99.2 2000-02-19    43.6          1</span>
<span class="co">#&gt;  2     1     1 1956-08-11  196.  2001-07-20    45.0          2</span>
<span class="co">#&gt;  3     2     0 1953-09-23   62.6 2000-03-20    46.5          1</span>
<span class="co">#&gt;  4     2     0 1953-09-23  155.  2001-12-06    48.2          2</span>
<span class="co">#&gt;  5     3     1 1968-10-01   21.8 2000-03-10    31.5          1</span>
<span class="co">#&gt;  6     3     1 1968-10-01  117.  2002-07-02    33.8          2</span>
<span class="co">#&gt;  7     4     1 1954-06-01   89.9 2000-10-11    46.4          1</span>
<span class="co">#&gt;  8     4     1 1954-06-01  145.  2002-01-07    47.6          2</span>
<span class="co">#&gt;  9     5     1 1956-09-22   50.6 2000-10-14    44.1          1</span>
<span class="co">#&gt; 10     5     1 1956-09-22  107.  2003-06-28    46.8          2</span>
<span class="co">#&gt; # ... with 281 more rows</span></code></pre></div>
</div>
<div id="transforming-the-measured-data" class="section level2">
<h2 class="hasAnchor">
<a href="#transforming-the-measured-data" class="anchor"></a>Transforming the Measured Data</h2>
<p>In order to join these datasets, a new ID has to be created to associate the spatial-temporal data with a specific measurement date. We create this ID to include all spatial data up to and including the measurement date for each subject.</p>
<p>Note that for subjects one and two there are two rows, corresponding to the two measurements. In contrast, subject nine has four rows, corresponding to the fact that subject 9’s move before the two measurements results in both locations of 9’s residence being associated with all measurements subsequently measured.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">subj_data <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/join.html">left_join</a></span>(subj_fdata,<span class="dt">by=</span><span class="st">"ID"</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(ID <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">9</span>)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/select.html">select</a></span>(ID,measure_ID,x,y,date,measure_date)
<span class="co">#&gt; # A tibble: 8 x 6</span>
<span class="co">#&gt;      ID measure_ID       x      y date       measure_date</span>
<span class="co">#&gt;   &lt;int&gt;      &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt; &lt;date&gt;     &lt;date&gt;      </span>
<span class="co">#&gt; 1     1          1 -0.701  -0.412 1974-05-11 2000-02-19  </span>
<span class="co">#&gt; 2     1          2 -0.701  -0.412 1974-05-11 2001-07-20  </span>
<span class="co">#&gt; 3     2          1 -0.415   0.622 1976-03-04 2000-03-20  </span>
<span class="co">#&gt; 4     2          2 -0.415   0.622 1976-03-04 2001-12-06  </span>
<span class="co">#&gt; 5     9          1 -0.0141 -0.708 1985-09-21 2000-03-14  </span>
<span class="co">#&gt; 6     9          2 -0.0141 -0.708 1985-09-21 2003-01-25  </span>
<span class="co">#&gt; 7     9          1  0.315  -0.145 1991-11-14 2000-03-14  </span>
<span class="co">#&gt; 8     9          2  0.315  -0.145 1991-11-14 2003-01-25</span></code></pre></div>
</div>
<div id="stores-opening-and-closing-subjects-moving-in-the-data" class="section level2">
<h2 class="hasAnchor">
<a href="#stores-opening-and-closing-subjects-moving-in-the-data" class="anchor"></a>Stores Opening and Closing, Subjects Moving in the Data</h2>
<p>Here we can see the effect of a store closing (BEF_ID 10) and a subject moving (subj_ID 9) on the data structure. Note that first row’s time is ~25.8 years which reflects the time spent since the <em>subject</em> first moved to their location. Since neither the subject nor the business moves by the subject’s second measurement in July of 2001, we see that the distances betwen subject 1 and Coffee Shop 1 stay constant, and the time increases according to the difference in measurement date, only.</p>
<p>In contrast, we see the effect of a subject moving for subj_ID 9. Here (s)he has twice as many measurements to show her/his exposure to the same coffee shop at the different locations where subj 9 lived. This is shown most evidently in the constant exposure for for coffee shops at the 1985 location for subject 9. Since subject 9 moved after ~6 years, and coffee shop 1 hadn’t closed at that time, subject 9 only has 6 years of exposure to that coffee shop at that distance. Following this we can see a steadily increasing exposure until the coffee shop closes in 2002, roughly a year before the subject’s second measurement in ’03.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">td_data  <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(subj_ID <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">9</span>),bef_ID<span class="op">%in%</span><span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">10</span>)) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span>(subj_ID,measure_ID,bef_ID)
<span class="co">#&gt; # A tibble: 12 x 10</span>
<span class="co">#&gt;    subj_ID measure_ID bef_ID measure_date date_open  date_close date      </span>
<span class="co">#&gt;      &lt;int&gt;      &lt;dbl&gt;  &lt;int&gt; &lt;date&gt;       &lt;date&gt;     &lt;date&gt;     &lt;date&gt;    </span>
<span class="co">#&gt;  1       1          1      1 2000-02-19   1969-05-14 NA         1974-05-11</span>
<span class="co">#&gt;  2       1          1     10 2000-02-19   1961-05-18 2002-09-23 1974-05-11</span>
<span class="co">#&gt;  3       1          2      1 2001-07-20   1969-05-14 NA         1974-05-11</span>
<span class="co">#&gt;  4       1          2     10 2001-07-20   1961-05-18 2002-09-23 1974-05-11</span>
<span class="co">#&gt;  5       9          1      1 2000-03-14   1969-05-14 NA         1985-09-21</span>
<span class="co">#&gt;  6       9          1      1 2000-03-14   1969-05-14 NA         1991-11-14</span>
<span class="co">#&gt;  7       9          1     10 2000-03-14   1961-05-18 2002-09-23 1985-09-21</span>
<span class="co">#&gt;  8       9          1     10 2000-03-14   1961-05-18 2002-09-23 1991-11-14</span>
<span class="co">#&gt;  9       9          2      1 2003-01-25   1969-05-14 NA         1985-09-21</span>
<span class="co">#&gt; 10       9          2      1 2003-01-25   1969-05-14 NA         1991-11-14</span>
<span class="co">#&gt; 11       9          2     10 2003-01-25   1961-05-18 2002-09-23 1985-09-21</span>
<span class="co">#&gt; 12       9          2     10 2003-01-25   1961-05-18 2002-09-23 1991-11-14</span>
<span class="co">#&gt; # ... with 3 more variables: class &lt;chr&gt;, dist &lt;dbl&gt;, time &lt;time&gt;</span></code></pre></div>
</div>
<div id="simulating-and-estimating-a-stap-model" class="section level1">
<h1 class="hasAnchor">
<a href="#simulating-and-estimating-a-stap-model" class="anchor"></a>Simulating and Estimating a STAP model</h1>
<p>If we were to assume the following model from the previous data set-up</p>
<p><span class="math display">\[
E[Y_{ij}|b_i] = \alpha + Z_1\delta_{Income} + Z_{2}\delta_{sex} + Z_{3}\delta_{Age} + X(\theta_s,\theta_t)\beta_{Coffee} + b_i
\]</span> Where <span class="math display">\[
X(\theta_s,\theta_t) = \sum_{d\in\mathcal{D}} w_d(\frac{d}{\theta_s}) w_t(\frac{t}{\theta_t}) 
\]</span></p>
<p>and simulate it under the following fixed values</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">alpha &lt;-<span class="st"> </span><span class="dv">22</span>
delta &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dt">Income =</span> <span class="op">-</span>.<span class="dv">35</span>,<span class="dt">sex =</span> <span class="fl">1.1</span>, <span class="dt">Age =</span> <span class="fl">1.2</span>)
beta &lt;-<span class="st"> </span>.<span class="dv">5</span>
theta_s &lt;-<span class="st"> </span>.<span class="dv">8</span>
theta_t &lt;-<span class="st"> </span><span class="dv">34</span>
sigma &lt;-<span class="st"> </span><span class="dv">2</span>
tau &lt;-<span class="st"> </span><span class="fl">1.5</span>
d &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="dt">from =</span> <span class="dv">0</span>, <span class="dt">to =</span> <span class="kw">max</span>(td_data<span class="op">$</span>dist), <span class="dt">by =</span> <span class="fl">0.01</span>)
t &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="dt">from =</span> <span class="dv">0</span>, <span class="dt">to =</span> <span class="kw">as.numeric</span>(<span class="kw">max</span>(td_data<span class="op">$</span>time)), <span class="dt">by =</span> <span class="fl">0.05</span>)
w_s &lt;-<span class="st"> </span>pracma<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/pracma/topics/erfz">erfc</a></span>(d<span class="op">/</span>theta_s)
w_t &lt;-<span class="st"> </span>pracma<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/pracma/topics/erfz">erf</a></span>(t<span class="op">/</span>theta_t)</code></pre></div>
<p>We could see the individual spatial and temporal exposure functions</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">par</span>(<span class="dt">mfrow=</span><span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">2</span>))
<span class="kw">plot</span>(d,w_s,<span class="dt">type=</span><span class="st">'l'</span>, <span class="dt">main=</span><span class="st">"Spatial Decay"</span>,<span class="dt">xlab =</span> <span class="st">"Distance"</span>, <span class="dt">ylab =</span><span class="st">"Exposure"</span>)
<span class="kw">plot</span>(t,w_t,<span class="dt">type =</span> <span class="st">"l"</span>, <span class="dt">main =</span> <span class="st">"Temporal Accumulation"</span>,<span class="dt">xlab=</span><span class="st">'years'</span>, <span class="dt">ylab =</span> <span class="st">"Exposure"</span>)</code></pre></div>
<p><img src="longitudinal-I_files/figure-html/s-t-exp-1.png" width="700"></p>
<p>As well as the joint spatial-temporal exposure</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">st_exp &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="ot">NA</span>,<span class="dt">nrow=</span><span class="kw">length</span>(d),<span class="dt">ncol=</span><span class="kw">length</span>(t))
<span class="cf">for</span>(d_ix <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw">length</span>(d)){
    <span class="cf">for</span>(t_ix <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw">length</span>(t))
        st_exp[d_ix,t_ix] &lt;-<span class="st"> </span>pracma<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/pracma/topics/erfz">erfc</a></span>(d[d_ix]<span class="op">/</span>theta_s)<span class="op">*</span>pracma<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/pracma/topics/erfz">erf</a></span>(t[t_ix]<span class="op">/</span>theta_t)
}
<span class="kw"><a href="http://www.rdocumentation.org/packages/plot3D/topics/persp3D">persp3D</a></span>(d,t,st_exp,<span class="dt">phi =</span> <span class="dv">15</span>,<span class="dt">theta =</span> <span class="dv">45</span>,<span class="dt">xlab=</span><span class="st">"Distance"</span>,
        <span class="dt">ylab=</span><span class="st">"Time (years)"</span>, <span class="dt">zlab =</span> <span class="st">"Exposure"</span>, <span class="dt">ticktype=</span><span class="st">'detailed'</span>,
        <span class="dt">main =</span> <span class="st">"Spatial Temporal Exposure Across Space and Time"</span>)</code></pre></div>
<p><img src="longitudinal-I_files/figure-html/st_exp_plot-1.png" width="700"></p>
<p>This will result in the following exposure densities</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">td_data <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span>(subj_ID,measure_ID,date) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span>(<span class="dt">dist_exposure =</span> <span class="kw">sum</span>(pracma<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/pracma/topics/erfz">erfc</a></span>(dist<span class="op">/</span>theta_s)),
              <span class="dt">time_exposure =</span> <span class="kw">sum</span>(pracma<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/pracma/topics/erfz">erf</a></span>(<span class="kw">as.numeric</span>(time)<span class="op">/</span>theta_t)),
              <span class="dt">total_exposure =</span> <span class="kw">sum</span>(pracma<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/pracma/topics/erfz">erfc</a></span>(dist<span class="op">/</span>theta_s) <span class="op">*</span><span class="st"> </span>pracma<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/pracma/topics/erfz">erfc</a></span>(<span class="kw">as.numeric</span>(time)<span class="op">/</span>theta_t)) ) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw"><a href="http://www.rdocumentation.org/packages/tidyr/topics/gather">gather</a></span>(<span class="kw"><a href="http://dplyr.tidyverse.org/reference/reexports.html">contains</a></span>(<span class="st">"Exposure"</span>),<span class="dt">key=</span><span class="st">"Exposure_Type"</span>,<span class="dt">value =</span> <span class="st">"Exposure"</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(Exposure_Type <span class="op">!=</span><span class="st"> "total_exposure"</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/ggplot">ggplot</a></span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(<span class="dt">x=</span>Exposure,<span class="dt">fill=</span>Exposure_Type)) <span class="op">+</span><span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/geom_density">geom_density</a></span>(<span class="dt">alpha=</span><span class="fl">0.4</span>)  <span class="op">+</span><span class="st"> </span>
<span class="st">        </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/ggtheme">theme_bw</a></span>()</code></pre></div>
<p><img src="longitudinal-I_files/figure-html/separate_exposure-1.png" width="700"></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">td_data <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span>(subj_ID,measure_ID,date) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span>(<span class="dt">dist_exposure =</span> <span class="kw">sum</span>(pracma<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/pracma/topics/erfz">erfc</a></span>(dist<span class="op">/</span>theta_s)),
              <span class="dt">time_exposure =</span> <span class="kw">sum</span>(pracma<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/pracma/topics/erfz">erf</a></span>(<span class="kw">as.numeric</span>(time)<span class="op">/</span>theta_t)),
              <span class="dt">total_exposure =</span> <span class="kw">sum</span>(pracma<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/pracma/topics/erfz">erfc</a></span>(dist<span class="op">/</span>theta_s) <span class="op">*</span><span class="st"> </span>pracma<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/pracma/topics/erfz">erfc</a></span>(<span class="kw">as.numeric</span>(time)<span class="op">/</span>theta_t))) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw"><a href="http://www.rdocumentation.org/packages/tidyr/topics/gather">gather</a></span>(<span class="kw"><a href="http://dplyr.tidyverse.org/reference/reexports.html">contains</a></span>(<span class="st">"Exposure"</span>),<span class="dt">key=</span><span class="st">"Exposure_Type"</span>,<span class="dt">value =</span> <span class="st">"Exposure"</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(Exposure_Type <span class="op">==</span><span class="st"> "total_exposure"</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/ggplot">ggplot</a></span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(<span class="dt">x=</span>Exposure,<span class="dt">fill=</span>Exposure_Type)) <span class="op">+</span><span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/geom_density">geom_density</a></span>()  <span class="op">+</span><span class="st"> </span>
<span class="st">        </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/ggtheme">theme_bw</a></span>()</code></pre></div>
<p><img src="longitudinal-I_files/figure-html/total_exposure-1.png" width="700"></p>
<p>Below we see that after scaling and centering, the average exposure is higher for the second measurement. This makes sense because we’d expect individuals temporal exposure to continue to accumulate after the first measurement.</p>
<pre><code>#&gt; Joining, by = "ID"</code></pre>
<p><img src="longitudinal-I_files/figure-html/create_exposure-1.png" width="700"></p>
<p><img src="longitudinal-I_files/figure-html/unnamed-chunk-1-1.png" width="700"></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">subj_fdata &lt;-<span class="st"> </span>subj_fdata <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/join.html">left_join</a></span>(<span class="kw">cbind</span>(lme_inf<span class="op">$</span>fr,y),<span class="dt">by=</span><span class="kw">c</span>(<span class="st">"ID"</span>,<span class="st">"measure_ID"</span>))  <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">sex =</span> sex.x, <span class="dt">Coffee_Shop=</span> Coffee_Shop.x,<span class="dt">subj_ID=</span>ID,
           <span class="dt">centered_income =</span> <span class="st">`</span><span class="dt">I((Income - mean(Income))/sd(Income))</span><span class="st">`</span>,
           <span class="dt">centered_age =</span> <span class="st">`</span><span class="dt">I((Age - mean(Age))/sd(Age))</span><span class="st">`</span>) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/select.html">select</a></span>(<span class="op">-</span>Coffee_Shop.x,<span class="op">-</span>sex.x,<span class="op">-</span>sex.y,
           <span class="op">-</span>ID,<span class="st">`</span><span class="dt">I((Age - mean(Age))/sd(Age))</span><span class="st">`</span>,
           <span class="st">`</span><span class="dt">I((Income - mean(Income))/sd(Income))</span><span class="st">`</span>)</code></pre></div>
<p>The final datasets passed to the <code>stap_glmer</code> function will then be the subject specific data, and the td data above containing the subject ID, the BEF class label and the distance or time. These are displayed below</p>
<pre><code>#&gt; $subject_data
#&gt; # A tibble: 291 x 8
#&gt;    subj_ID Income measure_ID   Age ran_int     y   sex Coffee_Shop
#&gt;      &lt;int&gt;  &lt;dbl&gt;      &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;int&gt;       &lt;dbl&gt;
#&gt;  1       1   99.2          1  43.6   0.148  24.6     1      -0.509
#&gt;  2       2   62.6          1  46.5   0.243  23.9     0      -0.611
#&gt;  3       3   21.8          1  31.5   0.480  18.6     1      -0.686
#&gt;  4       4   89.9          1  46.4   1.03   25.8     1       0.353
#&gt;  5       5   50.6          1  44.1   1.01   24.4     1       0.807
#&gt;  6       6   19.5          1  40.7  -0.184  23.1     1      -0.722
#&gt;  7       7   67.2          1  46.7   0.127  27.1     1       0.789
#&gt;  8       8   79.1          1  41.6  -0.387  21.8     0      -0.571
#&gt;  9       9   66.8          1  34.0  -0.345  24.4     1       4.12 
#&gt; 10      10   67.2          1  48.9  -1.79   22.5     0      -0.883
#&gt; # ... with 281 more rows
#&gt; 
#&gt; $distance_data
#&gt; # A tibble: 17,875 x 6
#&gt;    subj_ID measure_ID date       bef_ID class        dist
#&gt;      &lt;int&gt;      &lt;dbl&gt; &lt;date&gt;      &lt;int&gt; &lt;chr&gt;       &lt;dbl&gt;
#&gt;  1       1          1 1974-05-11      1 Coffee_Shop  1.88
#&gt;  2       2          1 1976-03-04      1 Coffee_Shop  1.08
#&gt;  3       3          1 1976-04-15      1 Coffee_Shop  1.98
#&gt;  4       4          1 1986-12-24      1 Coffee_Shop  2.09
#&gt;  5       5          1 1987-07-17      1 Coffee_Shop  1.34
#&gt;  6       6          1 1974-01-31      1 Coffee_Shop  1.40
#&gt;  7       7          1 1988-06-05      1 Coffee_Shop  1.36
#&gt;  8       8          1 1975-01-01      1 Coffee_Shop  1.33
#&gt;  9       9          1 1985-09-21      1 Coffee_Shop  1.74
#&gt; 10       9          1 1991-11-14      1 Coffee_Shop  1.10
#&gt; # ... with 17,865 more rows
#&gt; 
#&gt; $time_data
#&gt; # A tibble: 17,875 x 6
#&gt;    subj_ID measure_ID date       bef_ID class       time            
#&gt;      &lt;int&gt;      &lt;dbl&gt; &lt;date&gt;      &lt;int&gt; &lt;chr&gt;       &lt;time&gt;          
#&gt;  1       1          1 1974-05-11      1 Coffee_Shop 25.7945205479452
#&gt;  2       2          1 1976-03-04      1 Coffee_Shop 24.0602739726027
#&gt;  3       3          1 1976-04-15      1 Coffee_Shop 23.9178082191781
#&gt;  4       4          1 1986-12-24      1 Coffee_Shop 13.8082191780822
#&gt;  5       5          1 1987-07-17      1 Coffee_Shop 13.2547945205479
#&gt;  6       6          1 1974-01-31      1 Coffee_Shop 26.6904109589041
#&gt;  7       7          1 1988-06-05      1 Coffee_Shop 12.5205479452055
#&gt;  8       8          1 1975-01-01      1 Coffee_Shop 25.3780821917808
#&gt;  9       9          1 1985-09-21      1 Coffee_Shop 6.15068493150685
#&gt; 10       9          1 1991-11-14      1 Coffee_Shop 8.33698630136986
#&gt; # ... with 17,865 more rows</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">fit &lt;-<span class="st"> </span><span class="kw"><a href="../reference/stap_glmer.html">stap_glmer</a></span>(y <span class="op">~</span><span class="st"> </span>centered_income <span class="op">+</span><span class="st">  </span>sex <span class="op">+</span><span class="st"> </span>centered_age <span class="op">+</span><span class="st"> </span><span class="kw">stap</span>(Coffee_Shop) <span class="op">+</span><span class="st"> </span>(<span class="dv">1</span><span class="op">|</span>subj_ID),
                  <span class="dt">family =</span> <span class="kw">gaussian</span>(<span class="dt">link=</span><span class="st">'identity'</span>),
                  <span class="dt">subject_data =</span> homog_longitudinal_subject_data,
                  <span class="dt">distance_data =</span> homog_longitudinal_distance_data,
                  <span class="dt">time_data =</span> homog_longitudinal_time_data,
                  <span class="dt">subject_ID =</span> <span class="st">'subj_ID'</span>,<span class="dt">measure_ID =</span> <span class="st">'measure_ID'</span>,
                  <span class="dt">prior_intercept =</span> <span class="kw"><a href="../reference/priors.html">normal</a></span>(<span class="dt">location =</span> <span class="dv">25</span>, <span class="dt">scale =</span> <span class="dv">4</span>, <span class="dt">autoscale =</span> F),
                  <span class="dt">prior =</span> <span class="kw"><a href="../reference/priors.html">normal</a></span>(<span class="dt">location =</span> <span class="dv">0</span>, <span class="dt">scale =</span> <span class="dv">4</span>,<span class="dt">autoscale=</span>F),
                  <span class="dt">prior_stap =</span> <span class="kw"><a href="../reference/priors.html">normal</a></span>(<span class="dt">location =</span> <span class="dv">0</span>, <span class="dt">scale =</span> <span class="dv">4</span>),
                  <span class="dt">prior_theta =</span> <span class="kw"><a href="../reference/priors.html">log_normal</a></span>(<span class="dt">location =</span> <span class="dv">1</span>, <span class="dt">scale =</span> <span class="dv">2</span>),
                  <span class="dt">max_distance =</span> <span class="dv">3</span>, <span class="dt">max_time =</span> <span class="dv">50</span>,
                  <span class="dt">chains =</span> <span class="dv">3</span>,
                  <span class="dt">iter =</span> <span class="fl">1E3</span>,
                  <span class="dt">cores =</span> <span class="dv">3</span>)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">est_mat &lt;-<span class="st"> </span><span class="kw">cbind</span>(<span class="kw"><a href="../reference/posterior_interval.stapreg.html">posterior_interval</a></span>(fit)[<span class="dv">1</span><span class="op">:</span><span class="dv">7</span>,],<span class="dt">Truth=</span><span class="kw">c</span>(alpha,delta,beta,theta_s,theta_t)) 
par_nms &lt;-<span class="st"> </span><span class="kw">rownames</span>(est_mat)
est_mat <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/reexports.html">as_data_frame</a></span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">parameters=</span>par_nms) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/ggplot">ggplot</a></span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(<span class="dt">x=</span>parameters,<span class="dt">y=</span>Truth)) <span class="op">+</span><span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/geom_point">geom_point</a></span>() <span class="op">+</span><span class="st"> </span>
<span class="st">    </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/geom_linerange">geom_linerange</a></span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(<span class="dt">ymin=</span><span class="st">`</span><span class="dt">5%</span><span class="st">`</span>,<span class="dt">ymax=</span><span class="st">`</span><span class="dt">95%</span><span class="st">`</span>)) <span class="op">+</span><span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/ggtheme">theme_bw</a></span>() <span class="op">+</span><span class="st"> </span>
<span class="st">    </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/coord_flip">coord_flip</a></span>() <span class="op">+</span><span class="st"> </span>
<span class="st">    </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/labs">ggtitle</a></span>(<span class="st">"Estimate Boundaries with True Values"</span>) <span class="op">+</span><span class="st"> </span>
<span class="st">    </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/labs">ylab</a></span>(<span class="st">"Parameter Units"</span>)</code></pre></div>
<p><img src="longitudinal-I_files/figure-html/unnamed-chunk-5-1.png" width="700"></p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#measurement-data">Measurement Data</a></li>
      <li><a href="#transforming-the-measured-data">Transforming the Measured Data</a></li>
      <li><a href="#stores-opening-and-closing-subjects-moving-in-the-data">Stores Opening and Closing, Subjects Moving in the Data</a></li>
      <li><a href="#simulating-and-estimating-a-stap-model">Simulating and Estimating a STAP model</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Adam Peterson.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://pkgdown.r-lib.org/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  

  </body>
</html>
