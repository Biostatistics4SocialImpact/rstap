<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>STAP-Spatial_Correlation • rstap</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js" integrity="sha384-cV+rhyOuRHc9Ub/91rihWcGmMmCXDeksTtCihMupQHSsi8GIIRDG0ThDc3HGQFJ3" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="STAP-Spatial_Correlation">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">rstap</a>
        <span class="label label-default" data-toggle="tooltip" data-placement="bottom" title="Released package">0.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/STAP_Introduction.html">STAP Introduction</a>
    </li>
    <li>
      <a href="../articles/STAP_Spatial_Correlation.html">STAP-Spatial_Correlation</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>STAP-Spatial_Correlation</h1>
                        <h4 class="author">Adam Peterson</h4>
            
      
      
      <div class="hidden name"><code>STAP_Spatial_Correlation.Rmd</code></div>

    </div>

    
    
<div id="motivation" class="section level1">
<h1 class="hasAnchor">
<a href="#motivation" class="anchor"></a>Motivation</h1>
<p>The purpose of this document is to identify what impact, if any, spatial correlation within and between built environment features may have on the ability of the rstap package estimating procedure to correctly estimate parameters. We’ll begin by loading in the appropriate libraries, including, the <code>rstap</code> package for modeling these kinds of data.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(rstap)
<span class="kw">library</span>(dplyr)
<span class="kw">library</span>(tidyr)
<span class="kw">library</span>(ggplot2)</code></pre></div>
<div id="within-feature-correlation" class="section level3">
<h3 class="hasAnchor">
<a href="#within-feature-correlation" class="anchor"></a>Within Feature Correlation</h3>
<p>To induce correlation between business locations, we generate the x and y coordinates from an inhomogenous poisson process, with intensity function <span class="math inline">\(f(x,y) = 200xy\)</span>. So the mean number of businesses increases as <span class="math inline">\(x\)</span> and <span class="math inline">\(y\)</span> increase.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">intenfun &lt;-<span class="st"> </span><span class="cf">function</span>(x,y) <span class="dv">200</span> <span class="op">*</span><span class="st"> </span>x <span class="op">*</span>y
x &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="dt">from =</span> <span class="dv">0</span>, <span class="dt">to =</span> <span class="dv">1</span>, <span class="dt">by =</span> <span class="fl">0.01</span>)
y &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="dt">from =</span> <span class="dv">0</span>, <span class="dt">to =</span> <span class="dv">1</span>, <span class="dt">by =</span> <span class="fl">0.01</span>)
xy &lt;-<span class="st"> </span><span class="kw">expand.grid</span>(<span class="dt">x=</span>x,<span class="dt">y=</span>y)
z &lt;-<span class="st"> </span><span class="kw">intenfun</span>(xy<span class="op">$</span>x,xy<span class="op">$</span>y)
<span class="kw">cbind</span>(<span class="dt">x=</span>xy<span class="op">$</span>x,<span class="dt">y=</span>xy<span class="op">$</span>y,<span class="dt">mean =</span> z) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/reexports.html">as_data_frame</a></span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">cut_y =</span> <span class="kw">cut</span>(y,<span class="dv">4</span>)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/ggplot">ggplot</a></span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(<span class="dt">x=</span>x,<span class="dt">y=</span>y,<span class="dt">color=</span>z)) <span class="op">+</span><span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/geom_point">geom_point</a></span>() <span class="op">+</span><span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/scale_gradient">scale_color_continuous</a></span>(<span class="dt">low=</span><span class="st">'white'</span>,<span class="dt">high=</span><span class="st">'red'</span>) <span class="op">+</span>
<span class="st">        </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/ggtheme">theme_bw</a></span>() <span class="op">+</span><span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/labs">ggtitle</a></span>(<span class="st">"Intensity Function: Mean of Poisson Across 2D Space"</span>)</code></pre></div>
<p><img src="STAP_Spatial_Correlation_files/figure-html/intensity_function_plot-1.png" width="700"></p>
<p>We continue to generate subjects uniformly across the space. The following plot shows where all subjects and built environment features are located in our artificial space.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">set.seed</span>(<span class="dv">2524</span>)
num_subj &lt;-<span class="st"> </span><span class="dv">550</span>
bef_rpp &lt;-<span class="st"> </span>spatstat<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/spatstat/topics/rpoispp">rpoispp</a></span>(intenfun, <span class="dt">lmax =</span> <span class="fl">5E3</span>)
bef_df &lt;-<span class="st"> </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/reexports.html">data_frame</a></span>(<span class="dt">x =</span> bef_rpp<span class="op">$</span>x,
                     <span class="dt">y =</span> bef_rpp<span class="op">$</span>y, <span class="dt">class =</span> <span class="st">'BEF'</span>)
sub_df &lt;-<span class="st"> </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/reexports.html">data_frame</a></span>(<span class="dt">x =</span> <span class="kw">runif</span>(<span class="dt">n =</span> num_subj, <span class="dt">min =</span> <span class="dv">0</span>, <span class="dt">max =</span> <span class="fl">1.0</span>),
                     <span class="dt">y =</span> <span class="kw">runif</span>(<span class="dt">n =</span> num_subj, <span class="dt">min =</span> <span class="dv">0</span>, <span class="dt">max =</span> <span class="fl">1.0</span>),
                     <span class="dt">class =</span> <span class="st">"Subject"</span>)
<span class="kw">rbind</span>(bef_df,sub_df) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/ggplot">ggplot</a></span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(<span class="dt">x=</span>x,<span class="dt">y=</span>y,<span class="dt">color=</span>class)) <span class="op">+</span><span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/geom_point">geom_point</a></span>() <span class="op">+</span><span class="st"> </span>
<span class="st">    </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/ggtheme">theme_bw</a></span>() <span class="op">+</span><span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/labs">ggtitle</a></span>(<span class="st">"Correlated Business Positions"</span>)</code></pre></div>
<p><img src="STAP_Spatial_Correlation_files/figure-html/initialize_data-1.png" width="700"></p>
<p>Then suppose the form of some measurement on the subjects is:</p>
<p><span class="math display">\[
E[Y_i] = \alpha + Z_i \delta + X_i(\theta)\beta_2\\
X_i(\theta) = \sum_{d \in \mathcal{D}_i} \text{w}(\frac{d}{\theta})
\]</span></p>
<p>Using the following fixed parameter estimates.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">alpha &lt;-<span class="st"> </span><span class="fl">22.5</span>
Z &lt;-<span class="st"> </span><span class="kw">rbinom</span>(<span class="dt">n =</span> num_subj, <span class="dt">prob =</span> .<span class="dv">45</span>, <span class="dt">size =</span> <span class="dv">1</span>)
delta &lt;-<span class="st"> </span><span class="op">-</span>.<span class="dv">8</span>
theta &lt;-<span class="st"> </span>.<span class="dv">3</span>
beta &lt;-<span class="st"> </span><span class="fl">1.2</span>
sigma &lt;-<span class="st"> </span><span class="fl">2.3</span></code></pre></div>
<p>Assuming the exposure is imposed across all current features, then this results in the following dataset and marginal distribution of the outcome.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">dists &lt;-<span class="st"> </span>fields<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/fields/topics/rdist">rdist</a></span>(<span class="kw">as.matrix</span>(sub_df[,<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>]),
                       <span class="kw">as.matrix</span>(bef_df[,<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>]))
X &lt;-<span class="st"> </span><span class="kw">apply</span>(dists,<span class="dv">1</span>,<span class="cf">function</span>(x) <span class="kw">sum</span>(pracma<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/pracma/topics/erfz">erfc</a></span>(x<span class="op">/</span>theta)))
X_tilde &lt;-<span class="st"> </span>(X<span class="op">-</span><span class="kw">mean</span>(X))<span class="op">/</span><span class="kw">sd</span>(X) ## center and scale the exposure effect
y &lt;-<span class="st"> </span>alpha <span class="op">+</span><span class="st"> </span>Z<span class="op">*</span>delta <span class="op">+</span><span class="st"> </span>X_tilde<span class="op">*</span>beta <span class="op">+</span><span class="st"> </span><span class="kw">rnorm</span>(<span class="dt">n =</span> num_subj, <span class="dt">mean =</span> <span class="dv">0</span>, <span class="dt">sd =</span> sigma)
<span class="kw">hist</span>(y)</code></pre></div>
<p><img src="STAP_Spatial_Correlation_files/figure-html/dists_df_1-1.png" width="700"></p>
<p>Additionally, this results in the following decay function and marginal distribution of “Exposure”.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">d &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="dt">from =</span> <span class="dv">0</span>, <span class="dt">to =</span> <span class="kw">max</span>(dists), <span class="dt">by =</span> <span class="fl">0.01</span>)
X_theta_one &lt;-<span class="st"> </span>pracma<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/pracma/topics/erfz">erfc</a></span>(d<span class="op">/</span>theta)
<span class="kw">par</span>(<span class="dt">mfrow =</span> <span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">2</span>))
<span class="kw">plot</span>(d,X_theta_one,<span class="dt">type=</span><span class="st">'l'</span>,<span class="dt">main =</span> <span class="st">"Exposure Decay Function"</span>, <span class="dt">xlab =</span> <span class="st">"Distance"</span>,
     <span class="dt">ylab =</span> <span class="st">"Exposure"</span>)
<span class="kw">hist</span>(X_tilde)</code></pre></div>
<p><img src="STAP_Spatial_Correlation_files/figure-html/exposure_1-1.png" width="700"></p>
<p>Modeling these data with rstap…</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">distance_data &lt;-<span class="st"> </span>dists <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/reexports.html">as_data_frame</a></span>() <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">subj_id =</span> <span class="dv">1</span><span class="op">:</span>num_subj) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw"><a href="http://www.rdocumentation.org/packages/tidyr/topics/gather">gather</a></span>(<span class="kw"><a href="http://dplyr.tidyverse.org/reference/reexports.html">contains</a></span>(<span class="st">"V"</span>), <span class="dt">key =</span> <span class="st">'BEF'</span>,<span class="dt">value =</span> <span class="st">'Distance'</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">BEF =</span> <span class="st">'Fast_Food'</span>)

subject_data &lt;-<span class="st"> </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/reexports.html">data_frame</a></span>(<span class="dt">subj_id =</span> <span class="dv">1</span><span class="op">:</span>num_subj,
                           <span class="dt">y =</span> y,
                           <span class="dt">sex =</span> <span class="kw">factor</span>(Z,<span class="dt">labels=</span><span class="kw">c</span>(<span class="st">"M"</span>,<span class="st">"F"</span>)))

fit &lt;-<span class="st"> </span><span class="kw"><a href="../reference/stap_glm.html">stap_glm</a></span>(<span class="dt">formula =</span> y <span class="op">~</span><span class="st"> </span>sex <span class="op">+</span><span class="st"> </span><span class="kw">stap</span>(Fast_Food),
                <span class="dt">subject_data =</span> subject_data,
                <span class="dt">distance_data =</span> distance_data,
                <span class="dt">family =</span> <span class="kw">gaussian</span>(<span class="dt">link =</span> <span class="st">'identity'</span>),
                <span class="dt">id_key =</span> <span class="st">'subj_id'</span>,
                <span class="dt">prior_intercept =</span> <span class="kw"><a href="../reference/priors.html">normal</a></span>(<span class="dt">location =</span> <span class="dv">25</span>, <span class="dt">scale =</span> <span class="dv">5</span>, <span class="dt">autoscale =</span> F),
                <span class="dt">prior_stap =</span> <span class="kw"><a href="../reference/priors.html">normal</a></span>(<span class="dt">location =</span> <span class="dv">0</span>, <span class="dt">scale =</span> <span class="dv">3</span>, <span class="dt">autoscale =</span> F),
                <span class="dt">prior_theta =</span> <span class="kw"><a href="../reference/priors.html">log_normal</a></span>(<span class="dt">location =</span> <span class="dv">0</span>, <span class="dt">scale =</span> <span class="dv">1</span>), 
                <span class="dt">prior_aux =</span> <span class="kw"><a href="../reference/priors.html">cauchy</a></span>(<span class="dt">location =</span> <span class="dv">0</span>,<span class="dt">scale =</span> <span class="dv">5</span>),
                <span class="dt">max_distance =</span> <span class="kw">max</span>(dists), <span class="dt">chains =</span> <span class="dv">1</span>) ## include all data
<span class="co">#&gt; </span>
<span class="co">#&gt; SAMPLING FOR MODEL 'continuous' NOW (CHAIN 1).</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Gradient evaluation took 0.005733 seconds</span>
<span class="co">#&gt; 1000 transitions using 10 leapfrog steps per transition would take 57.33 seconds.</span>
<span class="co">#&gt; Adjust your expectations accordingly!</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Iteration:    1 / 2000 [  0%]  (Warmup)</span>
<span class="co">#&gt; Iteration:  200 / 2000 [ 10%]  (Warmup)</span>
<span class="co">#&gt; Iteration:  400 / 2000 [ 20%]  (Warmup)</span>
<span class="co">#&gt; Iteration:  600 / 2000 [ 30%]  (Warmup)</span>
<span class="co">#&gt; Iteration:  800 / 2000 [ 40%]  (Warmup)</span>
<span class="co">#&gt; Iteration: 1000 / 2000 [ 50%]  (Warmup)</span>
<span class="co">#&gt; Iteration: 1001 / 2000 [ 50%]  (Sampling)</span>
<span class="co">#&gt; Iteration: 1200 / 2000 [ 60%]  (Sampling)</span>
<span class="co">#&gt; Iteration: 1400 / 2000 [ 70%]  (Sampling)</span>
<span class="co">#&gt; Iteration: 1600 / 2000 [ 80%]  (Sampling)</span>
<span class="co">#&gt; Iteration: 1800 / 2000 [ 90%]  (Sampling)</span>
<span class="co">#&gt; Iteration: 2000 / 2000 [100%]  (Sampling)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;  Elapsed Time: 44.2403 seconds (Warm-up)</span>
<span class="co">#&gt;                34.1006 seconds (Sampling)</span>
<span class="co">#&gt;                78.3409 seconds (Total)</span></code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">results &lt;-<span class="st"> </span><span class="kw">rbind</span>(<span class="kw">c</span>(alpha,delta,beta,theta),<span class="kw">coef</span>(fit))
<span class="kw">rownames</span>(results) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">"True"</span>,<span class="st">"Estimated"</span>)
results
<span class="co">#&gt;           (Intercept)       sexF Fast_Food Fast_Food_spatial_scale</span>
<span class="co">#&gt; True          22.5000 -0.8000000   1.20000               0.3000000</span>
<span class="co">#&gt; Estimated     22.4277 -0.8853724   1.20657               0.4295096</span></code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/se.html">se</a></span>(fit)
<span class="co">#&gt;             (Intercept)                    sexF               Fast_Food </span>
<span class="co">#&gt;              0.12820110              0.18597310              0.09752372 </span>
<span class="co">#&gt; Fast_Food_spatial_scale </span>
<span class="co">#&gt;              0.09280066</span></code></pre></div>
<p>From the above we can see that spatial correlation within built environment features does not eliminate the ability of <code>rstap</code> to correctly estimate the spatial scale. Comparing it to the <a href="https://biostatistics4socialimpact.github.io/rstap/articles/STAP_Introduction.html">introductory vignette</a> we can see it does not substantially increase the variance of the estimate either, compared to a completely independent configuration.</p>
</div>
<div id="between-and-within-feature-correlation" class="section level3">
<h3 class="hasAnchor">
<a href="#between-and-within-feature-correlation" class="anchor"></a>Between and Within Feature Correlation</h3>
<p>To induce correlation within <strong>and</strong> between business locations, we generate the x and y coordinates of both features from an inhomogenous poisson process, with the <strong>same</strong> intensity function <span class="math inline">\(f(x,y) = 200xy\)</span>. So the mean number of <em>both</em> businesses increases as <span class="math inline">\(x\)</span> and <span class="math inline">\(y\)</span> increase.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">set.seed</span>(<span class="dv">2524</span>)
intenfun &lt;-<span class="st"> </span><span class="cf">function</span>(x,y) <span class="dv">250</span> <span class="op">*</span><span class="st"> </span>x <span class="op">*</span><span class="st"> </span>y
bef_rpp &lt;-<span class="st"> </span>spatstat<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/spatstat/topics/rpoispp">rpoispp</a></span>(intenfun, <span class="dt">lmax =</span> <span class="dv">500</span>)
bef_df &lt;-<span class="st"> </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/reexports.html">data_frame</a></span>(<span class="dt">x =</span> bef_rpp<span class="op">$</span>x,
                     <span class="dt">y =</span> bef_rpp<span class="op">$</span>y, <span class="dt">class =</span> <span class="st">'BEF_1'</span>)
intenfun &lt;-<span class="st"> </span><span class="cf">function</span>(x,y) <span class="dv">250</span> <span class="op">*</span><span class="st"> </span>x <span class="op">*</span><span class="st"> </span>y
bef_rpp &lt;-<span class="st"> </span>spatstat<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/spatstat/topics/rpoispp">rpoispp</a></span>(intenfun, <span class="dt">lmax =</span> <span class="dv">500</span>)
bef_df &lt;-<span class="st"> </span><span class="kw">rbind</span>(bef_df,<span class="kw"><a href="http://dplyr.tidyverse.org/reference/reexports.html">data_frame</a></span>(<span class="dt">x =</span> bef_rpp<span class="op">$</span>x,
                     <span class="dt">y =</span> bef_rpp<span class="op">$</span>y, <span class="dt">class =</span> <span class="st">'BEF_2'</span>))
<span class="kw">rbind</span>(bef_df) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/ggplot">ggplot</a></span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(<span class="dt">x=</span>x,<span class="dt">y=</span>y,<span class="dt">color=</span>class)) <span class="op">+</span><span class="st"> </span>
<span class="st">    </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/geom_point">geom_point</a></span>() <span class="op">+</span><span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/ggtheme">theme_bw</a></span>()</code></pre></div>
<p><img src="STAP_Spatial_Correlation_files/figure-html/initialize_2-1.png" width="700"> Then suppose the form of some measurement on the subjects is:</p>
<p><span class="math display">\[
E[Y_i] = \alpha + Z_i \delta + X_{i,1}(\theta_1)\beta_2 + X_{i,2}(\theta_2)\beta_3 \\
X_{i,j}(\theta) = \sum_{d \in \mathcal{D}_i} \text{w}(\frac{d}{\theta_j}) \quad j = 1,2
\]</span></p>
<p>Here we use the following fixed parameters. Note that the spatial scales are different for each class of built environment feature.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">alpha &lt;-<span class="st"> </span><span class="fl">22.5</span>
Z &lt;-<span class="st"> </span><span class="kw">rbinom</span>(<span class="dt">n =</span> num_subj, <span class="dt">prob =</span> .<span class="dv">45</span>, <span class="dt">size =</span> <span class="dv">1</span>)
delta &lt;-<span class="st"> </span><span class="op">-</span>.<span class="dv">8</span>
theta &lt;-<span class="st"> </span>.<span class="dv">3</span>
theta_<span class="dv">2</span> &lt;-<span class="st"> </span>.<span class="dv">9</span>
beta &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="fl">1.2</span>,.<span class="dv">5</span>)
sigma &lt;-<span class="st"> </span><span class="fl">2.3</span></code></pre></div>
<p>supposing we (again) use all the data available (no exclusion distance), then this results in the following dataset</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">dists_<span class="dv">1</span> &lt;-<span class="st"> </span>fields<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/fields/topics/rdist">rdist</a></span>(<span class="kw">as.matrix</span>(sub_df[,<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>]),
                       <span class="kw">as.matrix</span>(bef_df[bef_df<span class="op">$</span>class<span class="op">==</span><span class="st">'BEF_1'</span>,<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>]))
X_<span class="dv">1</span> &lt;-<span class="st"> </span><span class="kw">apply</span>(dists_<span class="dv">1</span>,<span class="dv">1</span>,<span class="cf">function</span>(x) <span class="kw">sum</span>(pracma<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/pracma/topics/erfz">erfc</a></span>(x<span class="op">/</span>theta)))
X_tilde &lt;-<span class="st"> </span>(X_<span class="dv">1</span><span class="op">-</span><span class="kw">mean</span>(X_<span class="dv">1</span>))<span class="op">/</span><span class="kw">sd</span>(X_<span class="dv">1</span>) ## center and scale the exposure effect
dists_<span class="dv">2</span> &lt;-<span class="st"> </span>fields<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/fields/topics/rdist">rdist</a></span>(<span class="kw">as.matrix</span>(sub_df[,<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>]),
                       <span class="kw">as.matrix</span>(bef_df[bef_df<span class="op">$</span>class<span class="op">==</span><span class="st">'BEF_2'</span>,<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>]))
X_<span class="dv">2</span> &lt;-<span class="st"> </span><span class="kw">apply</span>(dists_<span class="dv">2</span>,<span class="dv">1</span>,<span class="cf">function</span>(x) <span class="kw">sum</span>(pracma<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/pracma/topics/erfz">erfc</a></span>(x<span class="op">/</span>theta_<span class="dv">2</span>)))
X_tilde &lt;-<span class="st"> </span><span class="kw">cbind</span>(X_tilde,(X_<span class="dv">2</span><span class="op">-</span><span class="kw">mean</span>(X_<span class="dv">2</span>))<span class="op">/</span><span class="kw">sd</span>(X_<span class="dv">2</span>))
y &lt;-<span class="st"> </span>alpha <span class="op">+</span><span class="st"> </span>Z<span class="op">*</span>delta <span class="op">+</span><span class="st"> </span>X_tilde <span class="op">%*%</span><span class="st"> </span>beta <span class="op">+</span><span class="st"> </span><span class="kw">rnorm</span>(<span class="dt">n =</span> num_subj, <span class="dt">mean =</span> <span class="dv">0</span>, <span class="dt">sd =</span> sigma)
<span class="kw">par</span>(<span class="dt">mfrow=</span><span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">2</span>))
<span class="kw">hist</span>(y)
<span class="kw">hist</span>(dists)</code></pre></div>
<p><img src="STAP_Spatial_Correlation_files/figure-html/dists_df_2-1.png" width="700"></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">d &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="dt">from =</span> <span class="dv">0</span>, <span class="dt">to =</span> <span class="kw">max</span>(dists), <span class="dt">by =</span> <span class="fl">0.01</span>)
X_theta_one &lt;-<span class="st"> </span>pracma<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/pracma/topics/erfz">erfc</a></span>(d<span class="op">/</span>theta)
X_theta_two &lt;-<span class="st"> </span>pracma<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/pracma/topics/erfz">erfc</a></span>(d<span class="op">/</span>theta_<span class="dv">2</span>)
<span class="kw">par</span>(<span class="dt">mfrow =</span> <span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">2</span>),<span class="dt">mar=</span><span class="kw">rep</span>(<span class="dv">1</span>,<span class="dv">4</span>))
<span class="kw">plot</span>(d,X_theta_one,<span class="dt">type=</span><span class="st">'l'</span>,<span class="dt">main =</span> <span class="st">"Exposure Decay Function BEF 1"</span>, <span class="dt">xlab =</span> <span class="st">"Distance"</span>, <span class="dt">ylab =</span> <span class="st">"Exposure"</span>)
<span class="kw">plot</span>(d,X_theta_two,<span class="dt">type=</span><span class="st">'l'</span>, <span class="dt">main =</span> <span class="st">"Exposure Decay Function BEF 2"</span>)
<span class="kw">hist</span>(X_tilde[,<span class="dv">1</span>])
<span class="kw">hist</span>(X_tilde[,<span class="dv">2</span>])</code></pre></div>
<p><img src="STAP_Spatial_Correlation_files/figure-html/exposure_2-1.png" width="700"></p>
<p>Since these businesses, let’s say they’re Fast Food Restaurants and Coffee shops, were generated using the same intensity function from an inhomogenous poisson model, we should expect the exposure to be correlated, since these businesses tend to be located in the same area - as indeed, they may be in real life as well.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">cor</span>(X_tilde[,<span class="dv">1</span>],X_tilde[,<span class="dv">2</span>])
<span class="co">#&gt; [1] 0.9193313</span></code></pre></div>
<p>Looking at a plot of the “Exposure” from each.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(X_<span class="dv">1</span>,X_<span class="dv">2</span>, <span class="dt">xlab =</span> <span class="st">"FFR Exposure"</span>, <span class="dt">ylab =</span> <span class="st">"Coffee Exposure"</span>,
     <span class="dt">main =</span> <span class="st">"Exposure Correlation"</span>)</code></pre></div>
<p><img src="STAP_Spatial_Correlation_files/figure-html/exposure_correlation_plot-1.png" width="700"></p>
<p>This may cause problems in our modeling, but we should check to make sure.</p>
<p>Then we model this with rstap in the following manner</p>
<pre><code>#&gt; 
#&gt; SAMPLING FOR MODEL 'continuous' NOW (CHAIN 1).
#&gt; 
#&gt; Gradient evaluation took 0.007895 seconds
#&gt; 1000 transitions using 10 leapfrog steps per transition would take 78.95 seconds.
#&gt; Adjust your expectations accordingly!
#&gt; 
#&gt; 
#&gt; Iteration:    1 / 2000 [  0%]  (Warmup)
#&gt; Iteration:  200 / 2000 [ 10%]  (Warmup)
#&gt; Iteration:  400 / 2000 [ 20%]  (Warmup)
#&gt; Iteration:  600 / 2000 [ 30%]  (Warmup)
#&gt; Iteration:  800 / 2000 [ 40%]  (Warmup)
#&gt; Iteration: 1000 / 2000 [ 50%]  (Warmup)
#&gt; Iteration: 1001 / 2000 [ 50%]  (Sampling)
#&gt; Iteration: 1200 / 2000 [ 60%]  (Sampling)
#&gt; Iteration: 1400 / 2000 [ 70%]  (Sampling)
#&gt; Iteration: 1600 / 2000 [ 80%]  (Sampling)
#&gt; Iteration: 1800 / 2000 [ 90%]  (Sampling)
#&gt; Iteration: 2000 / 2000 [100%]  (Sampling)
#&gt; 
#&gt;  Elapsed Time: 200.925 seconds (Warm-up)
#&gt;                153.215 seconds (Sampling)
#&gt;                354.14 seconds (Total)</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">results &lt;-<span class="st"> </span><span class="kw">rbind</span>(<span class="kw">c</span>(alpha,delta,beta,theta,theta_<span class="dv">2</span>),<span class="kw">coef</span>(fit))
<span class="kw">rownames</span>(results) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">"True"</span>,<span class="st">"Estimated"</span>)
results
<span class="co">#&gt;           (Intercept)       sexF Fast_Food Coffee_Shops</span>
<span class="co">#&gt; True         22.50000 -0.8000000  1.200000    0.5000000</span>
<span class="co">#&gt; Estimated    22.47067 -0.8193664  1.152086    0.4015794</span>
<span class="co">#&gt;           Fast_Food_spatial_scale Coffee_Shops_spatial_scale</span>
<span class="co">#&gt; True                    0.3000000                   0.900000</span>
<span class="co">#&gt; Estimated               0.2598541                   1.213853</span></code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/se.html">se</a></span>(fit)
<span class="co">#&gt;                (Intercept)                       sexF </span>
<span class="co">#&gt;                 0.12643135                 0.20377254 </span>
<span class="co">#&gt;                  Fast_Food               Coffee_Shops </span>
<span class="co">#&gt;                 0.33620101                 0.35404959 </span>
<span class="co">#&gt;    Fast_Food_spatial_scale Coffee_Shops_spatial_scale </span>
<span class="co">#&gt;                 0.07659055                 0.86640681</span></code></pre></div>
<p>Looking at the results above we can see that we’re able to capture the true scales and effects, but with much larger variability in the Coffee Scale as compared to before.</p>
<p>Examing the correlation between the exposure covariates, we can see we largely <strong>underestimate</strong> the true correlation.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">cors &lt;-<span class="st"> </span><span class="kw">sapply</span>(<span class="dv">1</span><span class="op">:</span><span class="kw">nrow</span>(fit<span class="op">$</span>x_tilde), <span class="cf">function</span>(x) <span class="kw">cor</span>(fit<span class="op">$</span>x_tilde[x,,<span class="dv">1</span>],fit<span class="op">$</span>x_tilde[x,,<span class="dv">2</span>], <span class="dt">method=</span><span class="st">'spearman'</span>))
<span class="kw">summary</span>(cors)
<span class="co">#&gt;    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span>
<span class="co">#&gt;  0.3122  0.4593  0.4870  0.4823  0.5136  0.5486</span></code></pre></div>
<p>The plots below showing the distribution in samples from the distribution of spatial scales illustrate this further.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">b &lt;-<span class="st"> </span>rstan<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/rstan/topics/stanfit-method-extract">extract</a></span>(fit<span class="op">$</span>stapfit)
<span class="kw">par</span>(<span class="dt">mfrow=</span><span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">2</span>))
<span class="kw">hist</span>(b<span class="op">$</span>theta[,<span class="dv">1</span>],<span class="dt">main=</span><span class="st">"FFR Spatial Scale"</span>)
<span class="kw">hist</span>(b<span class="op">$</span>theta[,<span class="dv">2</span>],<span class="dt">main=</span><span class="st">"Coffee Spatial Scale"</span>)</code></pre></div>
<p><img src="STAP_Spatial_Correlation_files/figure-html/unnamed-chunk-2-1.png" width="700"></p>
<p>To see whether this is a true consequence of correlation or simply the weak coffee shop effect we simulate a new data set with a stronger coffee shop effect.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">alpha &lt;-<span class="st"> </span><span class="fl">22.5</span>
Z &lt;-<span class="st"> </span><span class="kw">rbinom</span>(<span class="dt">n =</span> num_subj, <span class="dt">prob =</span> .<span class="dv">45</span>, <span class="dt">size =</span> <span class="dv">1</span>)
delta &lt;-<span class="st"> </span><span class="op">-</span>.<span class="dv">8</span>
theta &lt;-<span class="st"> </span>.<span class="dv">3</span>
theta_<span class="dv">2</span> &lt;-<span class="st"> </span>.<span class="dv">9</span>
beta &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="fl">1.2</span>,<span class="fl">2.5</span>)
sigma &lt;-<span class="st"> </span><span class="fl">2.3</span></code></pre></div>
<pre><code>#&gt; 
#&gt; SAMPLING FOR MODEL 'continuous' NOW (CHAIN 1).
#&gt; 
#&gt; Gradient evaluation took 0.00463 seconds
#&gt; 1000 transitions using 10 leapfrog steps per transition would take 46.3 seconds.
#&gt; Adjust your expectations accordingly!
#&gt; 
#&gt; 
#&gt; Iteration:    1 / 2000 [  0%]  (Warmup)
#&gt; Iteration:  200 / 2000 [ 10%]  (Warmup)
#&gt; Iteration:  400 / 2000 [ 20%]  (Warmup)
#&gt; Iteration:  600 / 2000 [ 30%]  (Warmup)
#&gt; Iteration:  800 / 2000 [ 40%]  (Warmup)
#&gt; Iteration: 1000 / 2000 [ 50%]  (Warmup)
#&gt; Iteration: 1001 / 2000 [ 50%]  (Sampling)
#&gt; Iteration: 1200 / 2000 [ 60%]  (Sampling)
#&gt; Iteration: 1400 / 2000 [ 70%]  (Sampling)
#&gt; Iteration: 1600 / 2000 [ 80%]  (Sampling)
#&gt; Iteration: 1800 / 2000 [ 90%]  (Sampling)
#&gt; Iteration: 2000 / 2000 [100%]  (Sampling)
#&gt; 
#&gt;  Elapsed Time: 309.654 seconds (Warm-up)
#&gt;                302.022 seconds (Sampling)
#&gt;                611.676 seconds (Total)</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">results_CF &lt;-<span class="st"> </span><span class="kw">rbind</span>(<span class="kw">c</span>(alpha,delta,beta,theta,theta_<span class="dv">2</span>),<span class="kw">coef</span>(fit_CF))
<span class="kw">rownames</span>(results_CF) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">"True"</span>,<span class="st">"Estimated"</span>)
results_CF
<span class="co">#&gt;           (Intercept)       sexF Fast_Food Coffee_Shops</span>
<span class="co">#&gt; True         22.50000 -0.8000000  1.200000     2.500000</span>
<span class="co">#&gt; Estimated    22.38903 -0.7991213  1.782837     1.752011</span>
<span class="co">#&gt;           Fast_Food_spatial_scale Coffee_Shops_spatial_scale</span>
<span class="co">#&gt; True                    0.3000000                  0.9000000</span>
<span class="co">#&gt; Estimated               0.3354129                  0.9332912</span></code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/se.html">se</a></span>(fit_CF)
<span class="co">#&gt;                (Intercept)                       sexF </span>
<span class="co">#&gt;                  0.1282430                  0.1960483 </span>
<span class="co">#&gt;                  Fast_Food               Coffee_Shops </span>
<span class="co">#&gt;                  0.6225743                  0.6506946 </span>
<span class="co">#&gt;    Fast_Food_spatial_scale Coffee_Shops_spatial_scale </span>
<span class="co">#&gt;                  0.0958631                  0.4480910</span></code></pre></div>
<p>The lower variability in spatial scale in these most recent results suggest the former high variability likely was a consequence of the coffee shop effect, rather than the collinearity.</p>
</div>
<div id="conclusions" class="section level2">
<h2 class="hasAnchor">
<a href="#conclusions" class="anchor"></a>Conclusions</h2>
<p>This modeling framework can still estimate parameters in a setting where spatial coordinates are correlated, leading to correlated exposure covariates. This is important since built environment features will often be correlated in space. One qualification that should be made is that the intensity function above is relatively simple, and other intensity functions may induce differing correlation patterns. Additionally, differing processes that allow for greater within feature correlation, e.g. the Hawkes Process, may induce a correlation structure that may not be accounted for by this simulation’s set-up and results.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li>
<a href="#motivation">Motivation</a><ul class="nav nav-pills nav-stacked">
<li><a href="#conclusions">Conclusions</a></li>
      </ul>
</li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Adam Peterson.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://pkgdown.r-lib.org/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  

  </body>
</html>
