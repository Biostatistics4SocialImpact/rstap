<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Causal STAP Models • rstap</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Causal STAP Models">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">rstap</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.1.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/Introduction.html">STAP Introduction</a>
    </li>
    <li>
      <a href="../articles/stap_dnd_lmer.html">Causal STAP Models</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Causal STAP Models</h1>
            
      
      
      <div class="hidden name"><code>stap_dnd_lmer.Rmd</code></div>

    </div>

    
    
<div id="motivation" class="section level1">
<h1 class="hasAnchor">
<a href="#motivation" class="anchor"></a>Motivation</h1>
<p>Spatial-temporal aggregated predictor (STAP) models can be used in a longitudinal setting to model within and across subject differences by including subject specific means and subject differences from means. These <strong>difference in differences</strong> models can have a causal interpretation if certain assumptions are met. In a standard regression modeling framework, this would require a simple transformation of the time-varying confounders. For STAP models, since the variables being centered are random, they must be manipulated within each iteration of the sampler, requiring a different function and modeling syntax in <code>rstap</code> (as of v.1.1.0), which will be demonstrated in this vignette.</p>
<p>We’ll begin by loading the neccessary libraries</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(tidyverse)</a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(rstap)</a></code></pre></div>
<p>The data generation is similar to standard longitudinal simulation so we will omit the code here. It can be found on the Github site in the vignettes folder.</p>
<p>Note that we’ll generate the outcome under the difference in difference parameterization (see formula below) to make assessment of the parameters easy, and we’ll only include a subject specific intercept and slope, which <code>rstap</code> is currently limited to.</p>
</div>
<div id="simulating-and-estimating-a-stap-model" class="section level1">
<h1 class="hasAnchor">
<a href="#simulating-and-estimating-a-stap-model" class="anchor"></a>Simulating and Estimating a STAP model</h1>
<p>Consider the following model examining the average of some continuous outcome as a function of coffee shop exposure and confounders, conditional on latent subject covariates, <span class="math inline">\(b_i\)</span></p>
<p><span class="math display">\[
E[Y_{ij}|b_i] = \alpha +  \Delta X_{ij}(\theta_s)\beta_{i,Coffee} + \bar{X}_{ij}(\theta_s)\bar{\beta}_{i,Coffee} +  + Z_{1}\delta_{i,sex}  + b_i + b_i*w_{ij}
\]</span> where <span class="math display">\[
\Delta X(\theta_s) = \overbrace{\sum_{d\in\mathcal{D}} w_d(\frac{d}{\theta_s}) }^{X_{ij}(\theta_s)}  - \underbrace{\sum_{j=1}^{n_i}\sum_{d\in\mathcal{D}} w_d(\frac{d}{\theta_s})}_{\bar{X}_{ij}(\theta_s)}
\]</span></p>
<p>The <span class="math inline">\(\bar{X}_{ij}\)</span> serves as an estimate of a given subject’s average exposure to coffee shops across all measurements, so that <span class="math inline">\(\Delta X_{ij}(\theta_s)\)</span> represents the difference in “usual” exposure implying that <span class="math inline">\(\beta_{i,Coffee}\)</span> represents the within subject difference of increased Coffee exposure on the outcome, while <span class="math inline">\(\bar{\beta}\)</span> represents the difference across or between subjects for one unit increase in <span class="math inline">\(\bar{X}_{ij}(\theta_s)\)</span>, the average subject exposure.</p>
<p>We combine these two main effect estimates with standard, non time-varying confounders - only sex is used here - as well as random intercepts and slopes for each subject to account for correlation within subjects across measurements. Although one will also have to include other built environment features that may be often colocated with one another to truly remove all sources of confounding, requiring a <strong>lot</strong> of data, this model represents the best attempt one can make at estimating the causal effect of a built environment feature.</p>
<p>We’ll fit the model with priors that reflect our relative uncertainty about the spatial and temporal scales and place a fairly uninformative prior on the subject-specific variance. For information on how priors are set on the subject specific covariance, see the <code>rstanarm</code> vignette’s write up <a href="http://mc-stan.org/rstanarm/articles/glmer.html">here</a>. The functional form will be the same as the model under which it was simulated since this vignette is for exposition.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1">fit &lt;-<span class="st"> </span><span class="kw"><a href="../reference/stap_glmer.html">stapdnd_lmer</a></span>(BMI <span class="op">~</span><span class="st"> </span>Sex <span class="op">+</span><span class="st"> </span><span class="kw">sap_dnd_bar</span>(Coffee_Shop,wei) <span class="op">+</span><span class="st"> </span>(time<span class="op">|</span>id),</a>
<a class="sourceLine" id="cb2-2" data-line-number="2">                  <span class="dt">subject_data =</span> subj_df, <span class="co">## names of datasets </span></a>
<a class="sourceLine" id="cb2-3" data-line-number="3">                  <span class="dt">distance_data =</span> dists,<span class="co">##  simulated above</span></a>
<a class="sourceLine" id="cb2-4" data-line-number="4">                  <span class="dt">subject_ID =</span> <span class="st">'id'</span>,</a>
<a class="sourceLine" id="cb2-5" data-line-number="5">                  <span class="dt">group_ID =</span> <span class="st">"time"</span>,</a>
<a class="sourceLine" id="cb2-6" data-line-number="6">                  <span class="dt">prior_intercept =</span> <span class="kw"><a href="../reference/priors.html">normal</a></span>(<span class="dt">location =</span> <span class="dv">25</span>, <span class="dt">scale =</span> <span class="dv">4</span>, <span class="dt">autoscale =</span> F),</a>
<a class="sourceLine" id="cb2-7" data-line-number="7">                  <span class="dt">prior =</span> <span class="kw"><a href="../reference/priors.html">normal</a></span>(<span class="dt">location =</span> <span class="dv">0</span>, <span class="dt">scale =</span> <span class="dv">3</span>,<span class="dt">autoscale=</span>F),</a>
<a class="sourceLine" id="cb2-8" data-line-number="8">                  <span class="dt">prior_stap =</span> <span class="kw"><a href="../reference/priors.html">normal</a></span>(<span class="dt">location =</span> <span class="dv">0</span>, <span class="dt">scale =</span> <span class="dv">3</span>),</a>
<a class="sourceLine" id="cb2-9" data-line-number="9">                  <span class="dt">prior_theta =</span> <span class="kw"><a href="../reference/priors.html">log_normal</a></span>(<span class="dt">location =</span> <span class="dv">1</span>,<span class="dt">scale =</span> <span class="dv">1</span>),</a>
<a class="sourceLine" id="cb2-10" data-line-number="10">                  <span class="dt">max_distance =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Extremes">max</a></span>(dists<span class="op">$</span>Distance),</a>
<a class="sourceLine" id="cb2-11" data-line-number="11">                  <span class="dt">prior_covariance =</span> <span class="kw"><a href="../reference/priors.html">decov</a></span>(<span class="dt">regularization =</span> <span class="dv">1</span>,<span class="dt">concentration =</span> <span class="dv">1</span>,<span class="dt">shape =</span> <span class="dv">1</span>,<span class="dt">scale =</span> <span class="dv">1</span>),</a>
<a class="sourceLine" id="cb2-12" data-line-number="12">                  <span class="dt">chains =</span> <span class="dv">2</span>,</a>
<a class="sourceLine" id="cb2-13" data-line-number="13">                  <span class="dt">iter =</span> <span class="dv">1000</span>,</a>
<a class="sourceLine" id="cb2-14" data-line-number="14">                  <span class="dt">cores =</span> <span class="dv">2</span>)</a></code></pre></div>
<p>We can now check our model estimates and see how they compare to the true values.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1">fit</a>
<a class="sourceLine" id="cb3-2" data-line-number="2"><span class="co">#&gt; stapdnd_lmer</span></a>
<a class="sourceLine" id="cb3-3" data-line-number="3"><span class="co">#&gt;  family:       gaussian [identity]</span></a>
<a class="sourceLine" id="cb3-4" data-line-number="4"><span class="co">#&gt;  formula:      BMI ~ Sex + sap_dnd_bar(Coffee_Shop, wei) + (time | id)</span></a>
<a class="sourceLine" id="cb3-5" data-line-number="5"><span class="co">#&gt;  observations: 240</span></a>
<a class="sourceLine" id="cb3-6" data-line-number="6"><span class="co">#&gt;  Intercept:  TRUE</span></a>
<a class="sourceLine" id="cb3-7" data-line-number="7"><span class="co">#&gt;  fixed predictors:   1</span></a>
<a class="sourceLine" id="cb3-8" data-line-number="8"><span class="co">#&gt;  spatial predictors:  1</span></a>
<a class="sourceLine" id="cb3-9" data-line-number="9"><span class="co">#&gt;  temporal predictors:  0</span></a>
<a class="sourceLine" id="cb3-10" data-line-number="10"><span class="co">#&gt;  spatial-temporal predictors:  0</span></a>
<a class="sourceLine" id="cb3-11" data-line-number="11"><span class="co">#&gt; ------</span></a>
<a class="sourceLine" id="cb3-12" data-line-number="12"><span class="co">#&gt;                           Median MAD_SD</span></a>
<a class="sourceLine" id="cb3-13" data-line-number="13"><span class="co">#&gt; (Intercept)               21.8    1.1  </span></a>
<a class="sourceLine" id="cb3-14" data-line-number="14"><span class="co">#&gt; Sex                       -0.4    0.4  </span></a>
<a class="sourceLine" id="cb3-15" data-line-number="15"><span class="co">#&gt; Coffee_Shop_dnd            1.2    0.0  </span></a>
<a class="sourceLine" id="cb3-16" data-line-number="16"><span class="co">#&gt; Coffee_Shop_bar            0.7    0.2  </span></a>
<a class="sourceLine" id="cb3-17" data-line-number="17"><span class="co">#&gt; Coffee_Shop_spatial_scale  0.5    0.0  </span></a>
<a class="sourceLine" id="cb3-18" data-line-number="18"><span class="co">#&gt; Coffee_Shop_spatial_shape  3.5    0.6  </span></a>
<a class="sourceLine" id="cb3-19" data-line-number="19"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb3-20" data-line-number="20"><span class="co">#&gt; Auxiliary parameter(s):</span></a>
<a class="sourceLine" id="cb3-21" data-line-number="21"><span class="co">#&gt;       Median MAD_SD</span></a>
<a class="sourceLine" id="cb3-22" data-line-number="22"><span class="co">#&gt; sigma 1.0    0.1   </span></a>
<a class="sourceLine" id="cb3-23" data-line-number="23"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb3-24" data-line-number="24"><span class="co">#&gt; Error terms:</span></a>
<a class="sourceLine" id="cb3-25" data-line-number="25"><span class="co">#&gt;  Groups   Name        Std.Dev. Corr</span></a>
<a class="sourceLine" id="cb3-26" data-line-number="26"><span class="co">#&gt;  id       (Intercept) 1.15         </span></a>
<a class="sourceLine" id="cb3-27" data-line-number="27"><span class="co">#&gt;           time        0.83     0.11</span></a>
<a class="sourceLine" id="cb3-28" data-line-number="28"><span class="co">#&gt;  Residual             0.96         </span></a>
<a class="sourceLine" id="cb3-29" data-line-number="29"><span class="co">#&gt; Num.levels: id 80 </span></a>
<a class="sourceLine" id="cb3-30" data-line-number="30"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb3-31" data-line-number="31"><span class="co">#&gt; Sample avg. posterior predictive distribution of y:</span></a>
<a class="sourceLine" id="cb3-32" data-line-number="32"><span class="co">#&gt;          Median MAD_SD</span></a>
<a class="sourceLine" id="cb3-33" data-line-number="33"><span class="co">#&gt; mean_PPD 25.8    0.2  </span></a>
<a class="sourceLine" id="cb3-34" data-line-number="34"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb3-35" data-line-number="35"><span class="co">#&gt; ------</span></a>
<a class="sourceLine" id="cb3-36" data-line-number="36"><span class="co">#&gt; * For help interpreting the printed output see ?print.stapreg</span></a>
<a class="sourceLine" id="cb3-37" data-line-number="37"><span class="co">#&gt; * For info on the priors used see ?prior_summary.stapreg</span></a></code></pre></div>
<p><img src="stap_dnd_lmer_files/figure-html/parplot-1.png" width="700"></p>
<p><img src="stap_dnd_lmer_files/figure-html/ranef_parplot-1.png" width="700"></p>
<p>Below we can see the estimate of the spatial exposure function along with several draws from the posterior. <img src="stap_dnd_lmer_files/figure-html/weiplot-1.png" width="700"></p>
<div id="references" class="section level2">
<h2 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h2>
<p>More information on the parameterization of this model from an academic and technical perspective can be found in:</p>
<ol style="list-style-type: decimal">
<li>S. L. Morgan.Handbook of causal analysis for social research. Springer, 2013</li>
</ol>
<p>while the underlying fundamentals of the difference in differences model and its causal interpretation can be found in more lay-accessible book, “Mastering ’Metrics”, whose citation is below.</p>
<ol start="2" style="list-style-type: decimal">
<li>Angrist, Joshua D, and Jörn-Steffen Pischke. Mastering ’metrics: The Path from Cause to Effect. 2015. Print.</li>
</ol>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#motivation">Motivation</a></li>
      <li>
<a href="#simulating-and-estimating-a-stap-model">Simulating and Estimating a STAP model</a><ul class="nav nav-pills nav-stacked">
<li><a href="#references">References</a></li>
      </ul>
</li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Adam Peterson.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.3.0.</p>
</div>
      </footer>
</div>

  

  </body>
</html>
